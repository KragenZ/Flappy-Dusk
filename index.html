<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Flappy Dusk"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="theme-color" content="#0d0720"/>
<meta name="description" content="Flappy Bird Dusk Edition ‚Äî a beautiful flappy bird clone with skins, combos, near misses, power-ups and ambient audio."/>
<title>Flappy Bird ‚Äî Dusk Edition</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json"/>

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png"/>
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png"/>
<link rel="apple-touch-icon" href="icons/icon-152.png"/>

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png"/>
<link rel="icon" type="image/png" sizes="96x96"  href="icons/icon-96.png"/>

<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700;900&display=swap" rel="stylesheet"/>

<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#050110;touch-action:none;-webkit-tap-highlight-color:transparent;user-select:none}
body{display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Nunito',sans-serif}

#gameWrapper{position:relative;z-index:10;border-radius:22px;box-shadow:0 0 0 2px rgba(255,209,102,.5),0 0 50px rgba(244,132,95,.4),0 0 120px rgba(107,79,162,.25),0 28px 90px rgba(0,0,0,.75)}
canvas{display:block;border-radius:22px}

#uiLayer{position:absolute;inset:0;pointer-events:none;border-radius:22px;overflow:hidden}
#heartRow{position:absolute;top:14px;left:14px;display:flex;gap:6px;font-size:1.35rem;filter:drop-shadow(0 2px 6px rgba(0,0,0,.6))}
#comboDisplay{position:absolute;top:62px;right:14px;font-family:'Fredoka One',cursive;font-size:1.05rem;color:#FFD166;text-shadow:0 0 12px rgba(255,200,50,.9);opacity:0;transition:opacity .3s;text-align:right;pointer-events:none}
#powerUpDisplay{position:absolute;bottom:72px;right:14px;font-size:1.3rem;opacity:0;transition:opacity .3s;pointer-events:none;text-shadow:0 2px 8px rgba(0,0,0,.6)}
#versionLabel{position:absolute;bottom:8px;right:10px;font-size:.62rem;color:rgba(255,255,255,.22);letter-spacing:1px;font-family:'Nunito',sans-serif}
#offlineBadge{position:absolute;top:14px;right:14px;font-size:.62rem;background:rgba(34,197,94,.2);color:#4ade80;border:1px solid rgba(74,222,128,.3);border-radius:8px;padding:3px 8px;display:none}

/* PWA install prompt */
#installBanner{position:fixed;bottom:0;left:0;right:0;z-index:999;background:linear-gradient(135deg,rgba(13,7,32,.97),rgba(26,10,62,.97));border-top:1px solid rgba(255,209,102,.25);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;transform:translateY(100%);transition:transform .4s cubic-bezier(.175,.885,.32,1.275);font-family:'Nunito',sans-serif}
#installBanner.show{transform:translateY(0)}
#installBanner .ib-left{display:flex;align-items:center;gap:10px}
#installBanner .ib-icon{font-size:2rem}
#installBanner .ib-text .ib-title{font-weight:900;font-size:.9rem;color:#FFD166}
#installBanner .ib-text .ib-sub{font-size:.72rem;color:rgba(255,255,255,.5)}
#installBanner .ib-actions{display:flex;gap:8px;flex-shrink:0}
.ib-btn{font-family:'Fredoka One',cursive;font-size:.88rem;padding:8px 16px;border-radius:10px;border:none;cursor:pointer}
.ib-btn.primary{background:linear-gradient(135deg,#FFD166,#F4845F);color:#1a0a2e}
.ib-btn.ghost{background:rgba(255,255,255,.08);color:rgba(255,255,255,.6);border:1px solid rgba(255,255,255,.12)}

.screen{position:absolute;inset:0;border-radius:22px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:rgba(2,0,12,.92);backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px)}
.screen.hidden{display:none}

/* MAIN MENU */
#menuScreen .logo-bird{font-size:3.8rem;filter:drop-shadow(0 0 24px rgba(255,200,50,.9));animation:bob 1.9s ease-in-out infinite}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-11px)}}
#menuScreen .game-title{font-family:'Fredoka One',cursive;font-size:clamp(2.2rem,9vw,3.2rem);background:linear-gradient(135deg,#FFD166,#F4845F,#F28482);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:titleGlow 2.2s ease-in-out infinite;letter-spacing:1px}
@keyframes titleGlow{0%,100%{filter:drop-shadow(0 0 14px rgba(255,180,50,.5))}50%{filter:drop-shadow(0 0 34px rgba(255,180,50,1))}}
#menuScreen .tagline{color:rgba(255,255,255,.5);font-size:clamp(.78rem,2.8vw,.95rem);letter-spacing:.5px;margin-bottom:4px}

.menu-best-box{background:rgba(255,255,255,.07);border:1px solid rgba(255,209,102,.2);border-radius:14px;padding:10px 28px;text-align:center;margin:2px 0}
.menu-best-box .mbb-label{font-size:.68rem;color:rgba(255,255,255,.4);letter-spacing:2px;text-transform:uppercase}
.menu-best-box .mbb-val{font-family:'Fredoka One',cursive;font-size:2rem;color:#FFD166;line-height:1.1}

.skin-strip{display:flex;gap:12px;margin:4px 0}
.skin-thumb{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.6rem;border:2px solid rgba(255,255,255,.15);cursor:pointer;transition:transform .15s,border-color .15s;position:relative}
.skin-thumb.active{border-color:#FFD166;transform:scale(1.12)}
.skin-thumb.locked{filter:grayscale(.8) brightness(.5)}
.skin-thumb .lock-icon{position:absolute;bottom:-2px;right:-2px;font-size:.65rem;background:#222;border-radius:50%;padding:1px 3px}

.menu-btn-row{display:flex;flex-direction:column;gap:8px;width:200px;margin-top:6px}
.menu-btn{padding:12px 0;font-family:'Fredoka One',cursive;font-size:1.1rem;border:none;border-radius:14px;cursor:pointer;transition:transform .14s,box-shadow .14s;-webkit-tap-highlight-color:transparent;display:flex;align-items:center;justify-content:center;gap:8px}
.menu-btn.primary{background:linear-gradient(135deg,#FFD166,#F4845F);color:#1a0a2e;box-shadow:0 4px 22px rgba(244,132,95,.5)}
.menu-btn.primary:hover{transform:scale(1.05) translateY(-2px);box-shadow:0 8px 30px rgba(244,132,95,.7)}
.menu-btn.secondary{background:rgba(255,255,255,.08);color:rgba(255,255,255,.8);border:1px solid rgba(255,255,255,.12)}
.menu-btn.secondary:hover{background:rgba(255,255,255,.14);transform:translateY(-1px)}
.menu-btn:active{transform:scale(.96) !important}

/* SETTINGS */
#settingsScreen .settings-title{font-family:'Fredoka One',cursive;font-size:1.8rem;color:#FFD166;margin-bottom:6px}
.setting-row{display:flex;align-items:center;justify-content:space-between;width:220px;padding:10px 14px;background:rgba(255,255,255,.06);border-radius:12px;border:1px solid rgba(255,255,255,.1)}
.setting-row .sr-label{color:rgba(255,255,255,.8);font-size:.9rem;font-weight:700}
.toggle{width:44px;height:24px;border-radius:12px;border:none;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:transform .2s}
.toggle.on{background:#22c55e}
.toggle.on::after{transform:translateX(20px)}
.toggle.off{background:#4b5563}

/* LEADERBOARD */
#leaderboardScreen .lb-title{font-family:'Fredoka One',cursive;font-size:1.8rem;color:#FFD166;margin-bottom:6px}
.lb-list{width:240px;display:flex;flex-direction:column;gap:6px;max-height:260px;overflow-y:auto}
.lb-row{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border-radius:10px;padding:8px 12px;border:1px solid rgba(255,255,255,.08)}
.lb-rank{font-family:'Fredoka One',cursive;font-size:1.1rem;color:rgba(255,255,255,.4);width:24px;text-align:center}
.lb-rank.gold{color:#FFD166}
.lb-rank.silver{color:#d1d5db}
.lb-rank.bronze{color:#d97706}
.lb-name{flex:1;color:#fff;font-size:.88rem;font-weight:700}
.lb-score{font-family:'Fredoka One',cursive;font-size:1.1rem;color:#86efac}
.lb-empty{color:rgba(255,255,255,.35);font-size:.85rem;text-align:center;padding:20px 0}

/* GAME OVER / STATS */
#statsScreen{background:rgba(2,0,12,.96);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
#statsScreen .stats-title{font-family:'Fredoka One',cursive;font-size:2.2rem;margin-bottom:2px;color:#fff;text-shadow:0 2px 20px rgba(0,0,0,.8)}
#statsScreen .stats-medal{font-size:3rem;margin:2px 0;filter:drop-shadow(0 0 20px rgba(255,200,50,.9))}
#statsScreen .stats-msg{color:rgba(255,255,255,.75);font-size:.92rem;margin-bottom:6px;text-shadow:0 1px 6px rgba(0,0,0,.6)}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:240px}
.stat-cell{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:9px 10px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,.3)}
.stat-cell .cell-val{font-family:'Fredoka One',cursive;font-size:1.5rem;color:#fff;line-height:1;text-shadow:0 1px 8px rgba(0,0,0,.5)}
.stat-cell .cell-val.gold{color:#FFD166;text-shadow:0 0 14px rgba(255,209,102,.6)}
.stat-cell .cell-val.hot{color:#F4845F;text-shadow:0 0 14px rgba(244,132,95,.5)}
.stat-cell .cell-label{font-size:.64rem;color:rgba(255,255,255,.6);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px}
.new-best-badge{background:linear-gradient(135deg,#FFD166,#F4845F);color:#1a0a2e;font-family:'Fredoka One',cursive;font-size:.8rem;padding:3px 10px;border-radius:20px;letter-spacing:1px;display:none;box-shadow:0 2px 12px rgba(244,132,95,.5)}

.action-row{display:flex;gap:10px;margin-top:4px}
.act-btn{padding:12px 24px;font-family:'Fredoka One',cursive;font-size:1rem;border:none;border-radius:14px;cursor:pointer;transition:transform .14s;-webkit-tap-highlight-color:transparent}
.act-btn.primary{background:linear-gradient(135deg,#FFD166,#F4845F);color:#1a0a2e;box-shadow:0 4px 20px rgba(244,132,95,.5)}
.act-btn.ghost{background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.12)}
.act-btn:hover{transform:scale(1.05) translateY(-1px)}
.act-btn:active{transform:scale(.95)}

#hint{position:relative;z-index:10;margin-top:12px;color:rgba(255,255,255,.25);font-size:clamp(.65rem,2.4vw,.78rem);letter-spacing:2px;text-transform:uppercase}

/* Countdown overlay */
#countdownOverlay{position:absolute;inset:0;border-radius:22px;display:none;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;z-index:50}
#countdownNum{font-family:'Fredoka One',cursive;font-size:clamp(72px,22vw,140px);color:#F4845F;line-height:1}
#countdownNum.pop{animation:cdpop .35s cubic-bezier(.175,.885,.32,1.4) forwards}
@keyframes cdpop{0%{transform:scale(1.6);opacity:.4}100%{transform:scale(1);opacity:1}}
#countdownReady{font-family:'Fredoka One',cursive;font-size:clamp(14px,4vw,22px);color:rgba(255,255,255,.7);letter-spacing:4px;margin-top:8px}

/* Pause overlay */
#pauseOverlay{position:absolute;inset:0;border-radius:22px;display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;background:rgba(5,1,20,.82);backdrop-filter:blur(12px)}
#pauseOverlay.show{display:flex}
#pauseOverlay .pause-title{font-family:'Fredoka One',cursive;font-size:2.5rem;color:#FFD166}
#pauseOverlay .pause-sub{color:rgba(255,255,255,.4);font-size:.82rem;letter-spacing:2px}

/* Power-up bar */
#powerBar{position:absolute;bottom:64px;left:50%;transform:translateX(-50%);display:flex;gap:8px;pointer-events:none;opacity:0;transition:opacity .3s}
.pu-slot{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.pu-slot.active{border-color:#FFD166;background:rgba(255,209,102,.15);animation:puPulse .8s ease-in-out infinite}
@keyframes puPulse{0%,100%{box-shadow:0 0 6px rgba(255,209,102,.3)}50%{box-shadow:0 0 18px rgba(255,209,102,.7)}}
</style>
</head>
<body>

<!-- PWA Install Banner -->
<div id="installBanner">
  <div class="ib-left">
    <div class="ib-icon">üê¶</div>
    <div class="ib-text">
      <div class="ib-title">Install Flappy Dusk</div>
      <div class="ib-sub">Play offline, anytime</div>
    </div>
  </div>
  <div class="ib-actions">
    <button class="ib-btn ghost" id="ib-dismiss">Not now</button>
    <button class="ib-btn primary" id="ib-install">Install</button>
  </div>
</div>

<div id="gameWrapper">
  <canvas id="gameCanvas"></canvas>

  <div id="uiLayer">
    <div id="heartRow"></div>
    <div id="comboDisplay"></div>
    <div id="powerUpDisplay"></div>
    <div id="powerBar"></div>
    <div id="offlineBadge">‚óè OFFLINE</div>
    <div id="versionLabel">v1.3.0</div>
  </div>

  <!-- Pause overlay (triggered by back button / P key) -->
  <div id="pauseOverlay">
    <div class="pause-title">‚è∏ Paused</div>
    <div class="pause-sub">TAP TO RESUME</div>
    <div class="action-row">
      <button class="act-btn ghost" id="pauseMenu">‚ò∞ Menu</button>
      <button class="act-btn primary" id="pauseResume">‚ñ∂ Resume</button>
    </div>
  </div>

  <!-- MAIN MENU -->
  <div id="menuScreen" class="screen">
    <div class="logo-bird">üê¶</div>
    <div class="game-title">Flappy Bird</div>
    <p class="tagline">Dusk Edition</p>
    <div class="menu-best-box">
      <div class="mbb-label">Best Score</div>
      <div class="mbb-val" id="menuBest">0</div>
    </div>
    <div class="skin-strip" id="skinStrip"></div>
    <div class="menu-btn-row">
      <button class="menu-btn primary" id="menuPlay">‚ñ∂ &nbsp;Play</button>
      <button class="menu-btn secondary" id="menuLeaderboard">üèÜ &nbsp;Leaderboard</button>
      <button class="menu-btn secondary" id="menuSettings">‚öôÔ∏è &nbsp;Settings</button>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="settingsScreen" class="screen hidden">
    <div class="settings-title">‚öôÔ∏è Settings</div>
    <div class="setting-row">
      <span class="sr-label">üîä Sound FX</span>
      <button class="toggle" id="toggleSfx"></button>
    </div>
    <div class="setting-row">
      <span class="sr-label">üéµ Music</span>
      <button class="toggle" id="toggleMusic"></button>
    </div>
    <div class="setting-row">
      <span class="sr-label">üì≥ Haptics</span>
      <button class="toggle" id="toggleHaptic"></button>
    </div>
    <div class="setting-row">
      <span class="sr-label">‚ö° Power-Ups</span>
      <button class="toggle" id="togglePowerups"></button>
    </div>
    <div class="action-row" style="margin-top:12px">
      <button class="act-btn ghost" id="settingsBack">‚Üê Back</button>
      <button class="act-btn ghost" id="resetScores">üóë Reset</button>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboardScreen" class="screen hidden">
    <div class="lb-title">üèÜ Leaderboard</div>
    <div class="lb-list" id="lbList"></div>
    <div class="action-row" style="margin-top:10px">
      <button class="act-btn ghost" id="lbBack">‚Üê Back</button>
    </div>
  </div>

  <!-- STATS / GAME OVER -->
  <div id="statsScreen" class="screen hidden">
    <div class="stats-medal" id="statsMedal"></div>
    <div class="stats-title" id="statsTitle"></div>
    <p class="stats-msg" id="statsMsg"></p>
    <span class="new-best-badge" id="newBestBadge">üèÖ NEW BEST!</span>
    <div class="stats-grid">
      <div class="stat-cell"><div class="cell-val" id="st_score">0</div><div class="cell-label">Score</div></div>
      <div class="stat-cell"><div class="cell-val gold" id="st_best">0</div><div class="cell-label">Best</div></div>
      <div class="stat-cell"><div class="cell-val hot" id="st_combo">0</div><div class="cell-label">Max Combo</div></div>
      <div class="stat-cell"><div class="cell-val" id="st_time">0s</div><div class="cell-label">Time</div></div>
      <div class="stat-cell"><div class="cell-val" id="st_pipes">0</div><div class="cell-label">Pipes</div></div>
      <div class="stat-cell"><div class="cell-val hot" id="st_near">0</div><div class="cell-label">Near Misses</div></div>
    </div>
    <div class="action-row">
      <button class="act-btn ghost" id="statsMenu">‚ò∞ Menu</button>
      <button class="act-btn primary" id="statsPlay">üîÑ Play Again</button>
    </div>
    <button class="act-btn ghost" id="statsLeaderboard" style="margin-top:4px;width:100%;max-width:210px;font-size:.85rem;padding:8px">üèÜ View Leaderboard</button>
  </div>
  <div id="countdownOverlay">
    <div id="countdownNum">3</div>
    <div id="countdownReady">GET READY</div>
  </div>
</div>

<p id="hint">Tap / Space to flap &nbsp;¬∑&nbsp; P to pause</p>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAYHXlmLBOPtFGjlX-VAqrnQ50-MHhhA_U",
  authDomain: "flappy-dusk.firebaseapp.com",
  projectId: "flappy-dusk",
  storageBucket: "flappy-dusk.firebasestorage.app",
  messagingSenderId: "156960066613",
  appId: "1:156960066613:web:2544aae541133a1a78b57c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
// ‚îÄ‚îÄ‚îÄ Canvas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');

let W, H, S = 1;
let BIRD_R, PIPE_W, BASE_GAP, GROUND_H, BASE_PIPE_SPEED, GRAVITY, BASE_FLAP;
let STARS = [], FAR_CLOUDS = [], MID_CLOUDS = [], NEAR_CLOUDS = [];
let MOUNTAINS_FAR = [], MOUNTAINS_NEAR = [], BUSHES = [];
let FIREFLIES = [], LEAVES = [], DUST = [], FG_BRANCHES = [];
let groundOffset = 0;
let particles = [], popups = [], ringPulses = [], trailDots = [];
let camX = 0, camY = 0, camT = 0;
let windNode = null;
let shakeAmt = 0, shakeX = 0, shakeY = 0;
let wingAngle = 0, wingDir = 1, flapBoost = false;
let birdIdleT = 0;
let bird, pipes, score, lives, animId, lastPipeTime;
let comboCount = 0, maxCombo = 0, lastPipePassTime = 0;
let pipeSpeed, gapSize, difficulty;
let invincibleTimer = 0, deathFrames = 0;
let sessionStart = 0, nearMissCount = 0;
let gameRunning = false, gameStarted = false, gamePaused = false;
let currentScreen = 'menu';
let activeSkin = parseInt(localStorage.getItem('fb_skin') || '0');
let powerupsOn  = localStorage.getItem('fb_powerups') !== 'off';

// Power-up system
let activePowerUp = null;  // { id, emoji, label, color, timer, maxTimer }
let powerUpQueue  = [];    // spawned items on screen
const POWERUP_TYPES = [
  { id:'shield',   emoji:'üõ°Ô∏è', color:'#86efac', label:'Shield',    duration:300 },
  { id:'slowmo',   emoji:'‚è±Ô∏è', color:'#c4b5fd', label:'Slow World',   duration:300 },
  { id:'magnet',   emoji:'üß≤', color:'#60a5fa', label:'Magnet',    duration:180 },
  { id:'tiny',     emoji:'üî¨', color:'#f9a8d4', label:'Tiny Bird', duration:360 },
];

const MAX_LIVES    = 3;
const PIPE_EVERY   = 1650;
const COMBO_WINDOW = 2200;
const VERSION      = 'v1.3.0';

// ‚îÄ‚îÄ‚îÄ Resize ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resize() {
  const vw = window.innerWidth, vh = window.innerHeight;
  let cw = Math.min(vw - 16, 420);
  let ch = Math.min(vh - 80, Math.round(cw * 16 / 9));
  if (ch > vh - 80) { ch = vh - 80; cw = Math.round(ch * 9 / 16); }
  canvas.width = cw; canvas.height = ch;
  W = cw; H = ch; S = W / 420;
  updateScaleConsts();
  rebuildBgAssets();
}

function updateScaleConsts() {
  BIRD_R          = Math.round(22 * S);
  PIPE_W          = Math.round(62 * S);
  BASE_GAP        = Math.round(165 * S);
  GROUND_H        = Math.round(56 * S);
  BASE_PIPE_SPEED = 2.55 * S;
  GRAVITY         = 0.41 * S;
  BASE_FLAP       = -8.8 * S;
}

window.addEventListener('resize', () => { resize(); if (!gameRunning) idleLoop(); });
resize();

// ‚îÄ‚îÄ‚îÄ Persistence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let bestScore = parseInt(localStorage.getItem('fb_best') || '0');
let sfxOn     = localStorage.getItem('fb_sfx')    !== 'off';
let musicOn   = localStorage.getItem('fb_music')  !== 'off';
let hapticOn  = localStorage.getItem('fb_haptic') !== 'off';

function savePref(key, val) { localStorage.setItem(key, val); }
function saveBest(s) {
  // Always record every run on the leaderboard
  saveLeaderboardEntry(s);
  if (s > bestScore) {
    bestScore = s;
    localStorage.setItem('fb_best', String(s));
    return true;
  }
  return false;
}

// ‚îÄ‚îÄ‚îÄ Leaderboard (top 10 local sessions) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getLeaderboard() {
  try { return JSON.parse(localStorage.getItem('fb_lb') || '[]'); } catch { return []; }
}
async function saveLeaderboardEntry(score) {
  try {
    await db.collection("leaderboard").add({
      score: score,
      name: localStorage.getItem("fb_name") || "Player",
      timestamp: Date.now()
    });
  } catch (e) {
    console.error("Leaderboard save failed", e);
  }
}
async function renderLeaderboard() {
  const list = document.getElementById('lbList');
  list.innerHTML = '<div class="lb-empty">Loading...</div>';
  try {
    const snap = await db
      .collection("leaderboard")
      .orderBy("score", "desc")
      .limit(10)
      .get();
    if (snap.empty) {
      list.innerHTML = '<div class="lb-empty">No scores yet.<br>Be the first!</div>';
      return;
    }
    const medals = ['gold','silver','bronze'];
    list.innerHTML = snap.docs.map((doc, i) => {
      const e = doc.data();
      return `<div class="lb-row">
        <span class="lb-rank ${medals[i]||''}">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1}</span>
        <span class="lb-name">${e.name || 'Player'}</span>
        <span class="lb-score">${e.score}</span>
      </div>`;
    }).join('');
  } catch (e) {
    console.error("Leaderboard load failed", e);
    list.innerHTML = '<div class="lb-empty">‚ö†Ô∏è Failed to load leaderboard</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const menuScreen       = document.getElementById('menuScreen');
const settingsScreen   = document.getElementById('settingsScreen');
const statsScreen      = document.getElementById('statsScreen');
const leaderboardScreen= document.getElementById('leaderboardScreen');
const pauseOverlay     = document.getElementById('pauseOverlay');
const menuBest         = document.getElementById('menuBest');
const heartRow         = document.getElementById('heartRow');
const comboDisplay     = document.getElementById('comboDisplay');
const powerUpDisplay   = document.getElementById('powerUpDisplay');
const powerBar         = document.getElementById('powerBar');
const skinStrip        = document.getElementById('skinStrip');
const offlineBadge     = document.getElementById('offlineBadge');
const toggleSfx        = document.getElementById('toggleSfx');
const toggleMusic      = document.getElementById('toggleMusic');
const toggleHaptic     = document.getElementById('toggleHaptic');
const togglePowerups   = document.getElementById('togglePowerups');
const statsMedal       = document.getElementById('statsMedal');
const statsTitle       = document.getElementById('statsTitle');
const statsMsg         = document.getElementById('statsMsg');
const newBestBadge     = document.getElementById('newBestBadge');
const st_score=document.getElementById('st_score'),st_best=document.getElementById('st_best');
const st_combo=document.getElementById('st_combo'),st_time=document.getElementById('st_time');
const st_pipes=document.getElementById('st_pipes'),st_near=document.getElementById('st_near');

// ‚îÄ‚îÄ‚îÄ Screen manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(name) {
  menuScreen.classList.add('hidden');
  settingsScreen.classList.add('hidden');
  statsScreen.classList.add('hidden');
  leaderboardScreen.classList.add('hidden');
  currentScreen = name;
  if (name === 'menu')        { menuScreen.classList.remove('hidden');        menuBest.textContent = bestScore; }
  if (name === 'settings')    settingsScreen.classList.remove('hidden');
  if (name === 'stats')       statsScreen.classList.remove('hidden');
  if (name === 'leaderboard') { leaderboardScreen.classList.remove('hidden'); renderLeaderboard(); }
}

// ‚îÄ‚îÄ‚îÄ Settings init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyToggle(btn, val) {
  btn.classList.toggle('on', val);
  btn.classList.toggle('off', !val);
}
applyToggle(toggleSfx,      sfxOn);
applyToggle(toggleMusic,    musicOn);
applyToggle(toggleHaptic,   hapticOn);
applyToggle(togglePowerups, powerupsOn);

toggleSfx.addEventListener('click', () => { sfxOn=!sfxOn; applyToggle(toggleSfx,sfxOn); savePref('fb_sfx',sfxOn?'on':'off'); });
toggleMusic.addEventListener('click', () => { musicOn=!musicOn; applyToggle(toggleMusic,musicOn); savePref('fb_music',musicOn?'on':'off'); musicOn?startAmbient():stopAmbient(); });
toggleHaptic.addEventListener('click', () => { hapticOn=!hapticOn; applyToggle(toggleHaptic,hapticOn); savePref('fb_haptic',hapticOn?'on':'off'); });
togglePowerups.addEventListener('click', () => { powerupsOn=!powerupsOn; applyToggle(togglePowerups,powerupsOn); savePref('fb_powerups',powerupsOn?'on':'off'); });

document.getElementById('resetScores').addEventListener('pointerdown', e => {
  e.stopPropagation();
  if (confirm('Reset all scores and leaderboard?')) {
    localStorage.removeItem('fb_best'); localStorage.removeItem('fb_lb');
    bestScore = 0; menuBest.textContent = 0;
    buildSkinStrip();
  }
});

// Button wiring
document.getElementById('menuPlay').addEventListener('pointerdown', e => { e.stopPropagation(); initGame(); });
document.getElementById('menuSettings').addEventListener('pointerdown', e => { e.stopPropagation(); showScreen('settings'); });
document.getElementById('menuLeaderboard').addEventListener('pointerdown', e => { e.stopPropagation(); showScreen('leaderboard'); });
document.getElementById('settingsBack').addEventListener('pointerdown', e => { e.stopPropagation(); showScreen('menu'); });
document.getElementById('lbBack').addEventListener('pointerdown', e => { e.stopPropagation(); showScreen('menu'); });
document.getElementById('statsMenu').addEventListener('pointerdown', e => { e.stopPropagation(); showScreen('menu'); idleLoop(); });
document.getElementById('statsPlay').addEventListener('pointerdown', e => { e.stopPropagation(); initGame(); });
document.getElementById('statsLeaderboard').addEventListener('pointerdown', e => { e.stopPropagation(); showScreen('leaderboard'); });
document.getElementById('pauseMenu').addEventListener('pointerdown', e => { e.stopPropagation(); resumeGame(); showScreen('menu'); idleLoop(); });
document.getElementById('pauseResume').addEventListener('pointerdown', e => { e.stopPropagation(); resumeGame(); });

// ‚îÄ‚îÄ‚îÄ Pause ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pauseGame() {
  if (!gameRunning || gamePaused) return;
  gamePaused = true;
  cancelAnimationFrame(animId);
  pauseOverlay.classList.add('show');
  stopAmbient();
  SFX.flap();
}
function resumeGame() {
  if (!gamePaused) return;
  gamePaused = false;
  pauseOverlay.classList.remove('show');
  if (musicOn) startAmbient();
  animId = requestAnimationFrame(gameLoop);
}

// Pause on canvas click when paused overlay is shown
pauseOverlay.addEventListener('pointerdown', e => {
  if (e.target === pauseOverlay) { e.stopPropagation(); resumeGame(); }
});

// ‚îÄ‚îÄ‚îÄ Skin system ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Drawing is handled entirely by individual draw functions (drawClassic, drawParrot etc.)
// SKINS only needs display info for the UI strip
const SKINS = [
  { emoji:'üê¶', label:'Classic',  unlockAt:0   },
  { emoji:'ü¶ú', label:'Parrot',   unlockAt:10  },
  { emoji:'ü¶Ö', label:'Eagle',    unlockAt:25  },
  { emoji:'ü¶â', label:'Owl',      unlockAt:50  },
  { emoji:'üêß', label:'Penguin',  unlockAt:75  },
  { emoji:'ü¶©', label:'Flamingo', unlockAt:100 },
];

function buildSkinStrip() {
  skinStrip.innerHTML = '';
  SKINS.forEach((sk, i) => {
    const locked = bestScore < sk.unlockAt;
    const el = document.createElement('div');
    el.className = 'skin-thumb' + (i === activeSkin ? ' active' : '') + (locked ? ' locked' : '');
    el.innerHTML = sk.emoji + (locked ? `<span class="lock-icon">üîí</span>` : '');
    el.title = locked ? `Unlock at score ${sk.unlockAt}` : sk.label;
    if (!locked) {
      el.addEventListener('pointerdown', e => {
        e.stopPropagation();
        activeSkin = i;
        localStorage.setItem('fb_skin', String(i));
        buildSkinStrip();
      });
    }
    skinStrip.appendChild(el);
  });
}
buildSkinStrip();

// ‚îÄ‚îÄ‚îÄ Web Audio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioCtx = null, ambientNodes = null;
function getAC() { if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }

// ‚îÄ‚îÄ Smooth sound helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Plays a soft sine tone with attack+decay envelope (no harsh clicks)
function playNote(freq, dur, vol=0.12, startFreq=null, endFreq=null) {
  if (!sfxOn) return;
  try {
    const ac=getAC(), osc=ac.createOscillator(), g=ac.createGain();
    // Low-pass filter kills any residual harshness
    const filt=ac.createBiquadFilter();
    filt.type='lowpass'; filt.frequency.value=3200;
    osc.connect(filt); filt.connect(g); g.connect(ac.destination);
    osc.type='sine';
    const t0=ac.currentTime;
    osc.frequency.setValueAtTime(startFreq||freq, t0);
    if (startFreq||endFreq) osc.frequency.exponentialRampToValueAtTime(endFreq||freq, t0+dur*0.7);
    // Soft attack (2ms) then decay ‚Äî prevents clicks completely
    g.gain.setValueAtTime(0, t0);
    g.gain.linearRampToValueAtTime(vol, t0+0.002);
    g.gain.setTargetAtTime(0, t0+dur*0.35, dur*0.28);
    osc.start(t0); osc.stop(t0+dur+0.05);
  } catch(e){}
}

// Layered chord ‚Äî plays multiple notes simultaneously for richer sounds
function playChord(freqs, dur, vol=0.09) {
  freqs.forEach(f => playNote(f, dur, vol));
}

// Soft noise burst (thud/whoosh) ‚Äî triangle wave pitched low, very filtered
function playThud(freq, dur, vol=0.11) {
  if (!sfxOn) return;
  try {
    const ac=getAC(), osc=ac.createOscillator(), g=ac.createGain();
    const filt=ac.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value=600;
    osc.connect(filt); filt.connect(g); g.connect(ac.destination);
    osc.type='triangle';
    osc.frequency.setValueAtTime(freq, ac.currentTime);
    osc.frequency.exponentialRampToValueAtTime(freq*0.3, ac.currentTime+dur);
    g.gain.setValueAtTime(0, ac.currentTime);
    g.gain.linearRampToValueAtTime(vol, ac.currentTime+0.004);
    g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime+dur);
    osc.start(); osc.stop(ac.currentTime+dur+0.05);
  } catch(e){}
}

const SFX = {
  // Soft rising whoosh ‚Äî flap
  flap: () => playNote(480, 0.10, 0.10, 320, 560),

  // Two-note pleasant ding
  score: () => {
    playNote(880, 0.18, 0.11);
    setTimeout(() => playNote(1108, 0.14, 0.08), 70);
  },

  // Bright ascending 3-note fanfare
  combo: () => {
    playNote(660, 0.13, 0.10);
    setTimeout(() => playNote(880, 0.13, 0.10), 65);
    setTimeout(() => playNote(1100, 0.18, 0.12), 130);
  },

  // Two quick soft pings ‚Äî near miss
  nearMiss: () => {
    playNote(660, 0.09, 0.09, 590, 700);
    setTimeout(() => playNote(800, 0.09, 0.08), 90);
  },

  // Low soft thud ‚Äî hit (no harsh static)
  hit: () => {
    playThud(160, 0.28, 0.13);
    playNote(220, 0.15, 0.07, 280, 180);
  },

  // Descending thud + low tone ‚Äî death
  die: () => {
    playThud(120, 0.50, 0.15);
    setTimeout(() => playNote(180, 0.35, 0.08, 220, 100), 80);
    setTimeout(() => playNote(110, 0.40, 0.07, 140, 80), 200);
  },

  // Rising chime ‚Äî shield / invincibility
  shield: () => {
    playChord([440, 554, 659], 0.22, 0.07);
    setTimeout(() => playNote(880, 0.18, 0.08), 100);
  },

  // Happy 3-step power chord
  powerUp: () => {
    playNote(523, 0.12, 0.10);
    setTimeout(() => playNote(659, 0.12, 0.10), 75);
    setTimeout(() => playNote(784, 0.18, 0.12), 150);
  },

  // Soft descending ‚Äî power-up expired
  powerDown: () => {
    playNote(440, 0.12, 0.09);
    setTimeout(() => playNote(330, 0.15, 0.09), 80);
    setTimeout(() => playNote(220, 0.18, 0.08), 170);
  },
};

function startAmbient() {
  if (!musicOn) return;
  stopAmbient();
  try {
    const ac=getAC(), masterGain=ac.createGain();
    masterGain.gain.setValueAtTime(0, ac.currentTime);
    masterGain.gain.linearRampToValueAtTime(0.18, ac.currentTime+3);
    masterGain.connect(ac.destination);
    const notes=[220,277.18,329.63,369.99];
    const oscs=notes.map(freq=>{
      const o=ac.createOscillator(), g=ac.createGain();
      o.type='sine'; o.frequency.value=freq; g.gain.value=0.25;
      o.connect(g); g.connect(masterGain); o.start(); return o;
    });
    const windGain=ac.createGain();
    windGain.gain.setValueAtTime(0, ac.currentTime);
    windGain.gain.linearRampToValueAtTime(0.08, ac.currentTime+4);
    windGain.connect(ac.destination);
    const windOscs=[180,200,220].map((f,i)=>{
      const o=ac.createOscillator(), g=ac.createGain();
      o.type='sawtooth'; o.frequency.value=f+i*7; g.gain.value=0.08;
      o.connect(g); g.connect(windGain); o.start(); return o;
    });
    windNode={windGain,windOscs};
    let t=0;
    const pulse=setInterval(()=>{
      if (!ambientNodes){clearInterval(pulse);return;}
      t+=0.04;
      const spd=1+(typeof difficulty==='number'?difficulty*0.5:0);
      masterGain.gain.setTargetAtTime(0.14+0.06*Math.sin(t*spd),ac.currentTime,0.3);
      // Slow-mo effect ‚Äî dim ambient
      const slowFactor = (activePowerUp?.id==='slowmo') ? 0.22 : 1;
      if (windNode) windGain.gain.setTargetAtTime((0.05+0.05*(typeof difficulty==='number'?difficulty:0))*slowFactor,ac.currentTime,0.8);
    },100);
    ambientNodes={oscs,masterGain,pulse,windOscs};
  }catch(e){}
}

function stopAmbient() {
  if (!ambientNodes) return;
  try {
    ambientNodes.masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+1.5);
    if (windNode) windNode.windGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+1.5);
    setTimeout(()=>{ ambientNodes.oscs.forEach(o=>{try{o.stop();}catch(e){}}); if(ambientNodes.windOscs)ambientNodes.windOscs.forEach(o=>{try{o.stop();}catch(e){}});},1600);
  }catch(e){}
  clearInterval(ambientNodes.pulse);
  ambientNodes=null; windNode=null;
}

// ‚îÄ‚îÄ‚îÄ Background assets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rebuildBgAssets() {
  STARS=Array.from({length:100},()=>({ x:Math.random()*W, y:Math.random()*H*0.72, r:Math.random()*1.8+0.3, a:Math.random()*0.55+0.3, ts:Math.random()*0.035+0.008, to:Math.random()*Math.PI*2 }));
  const mkCloud=(n,xm,ym,wMin,wMax,hMin,hMax,spd)=>Array.from({length:n},(_,i)=>({ x:(i/n)*W*xm, y:Math.random()*ym+20, w:Math.random()*(wMax-wMin)+wMin, h:Math.random()*(hMax-hMin)+hMin, spd }));
  FAR_CLOUDS  = mkCloud(6,1.7,H*.30,W*.12,W*.28,16,30,0.18);
  MID_CLOUDS  = mkCloud(5,1.6,H*.38,W*.10,W*.22,14,26,0.38);
  NEAR_CLOUDS = mkCloud(4,1.5,H*.44,W*.08,W*.18,10,20,0.65);
  const mkMtn=(yo,roughness)=>{const pts=[{x:0,y:H}];let mx=0;while(mx<=W+60){pts.push({x:mx,y:H*yo-Math.random()*H*roughness});mx+=Math.random()*50+24;}pts.push({x:W,y:H});return pts;};
  MOUNTAINS_FAR  = mkMtn(0.60,0.14);
  MOUNTAINS_NEAR = mkMtn(0.70,0.10);
  BUSHES=Array.from({length:12},(_,i)=>({ x:(i/12)*W*1.4, r:Math.random()*14*S+8*S, spd:BASE_PIPE_SPEED*0.6 }));
  FIREFLIES=Array.from({length:22},()=>({ x:Math.random()*W, y:Math.random()*(H*0.65)+H*0.05, vx:(Math.random()-.5)*0.35, vy:(Math.random()-.5)*0.2, r:Math.random()*2.2+1.0, phase:Math.random()*Math.PI*2, spd:Math.random()*0.04+0.02, color:Math.random()<0.6?'#c8ffb0':'#ffe080' }));
  LEAVES=Array.from({length:10},()=>({ x:Math.random()*W*1.5, y:Math.random()*(H*0.7)+H*0.05, vx:-(Math.random()*0.7+0.3), vy:Math.random()*0.18-0.09, rot:Math.random()*Math.PI*2, rotV:(Math.random()-.5)*0.04, size:Math.random()*5*S+3*S, alpha:Math.random()*0.4+0.2, wobble:Math.random()*Math.PI*2, wobbleSpd:Math.random()*0.03+0.01 }));
  DUST=Array.from({length:30},()=>({ x:Math.random()*W, y:Math.random()*H*0.8, vx:-(Math.random()*0.25+0.05), vy:(Math.random()-.5)*0.08, r:Math.random()*1.4+0.3, alpha:Math.random()*0.18+0.06, phase:Math.random()*Math.PI*2 }));
  FG_BRANCHES=Array.from({length:3},(_,i)=>({ x:(i/3)*W*1.8+W, y:Math.random()*(H*0.35), w:Math.random()*W*0.35+W*0.2, spd:BASE_PIPE_SPEED*1.55, side:Math.random()<0.5?'top':'bottom' }));
}

// ‚îÄ‚îÄ‚îÄ Particles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnParticles(x,y,n,colors,sm=1) {
  const space = 120 - particles.length; // hard cap at 120 ‚Äî prevents mobile lag
  const count = Math.min(n, Math.max(0, space));
  for (let i=0;i<count;i++) {
    const a=Math.random()*Math.PI*2, v=(Math.random()*4.5+0.8)*sm;
    particles.push({ x,y, vx:Math.cos(a)*v, vy:Math.sin(a)*v-2.2, r:Math.random()*7+2.5, life:1, color:colors[Math.floor(Math.random()*colors.length)], rot:Math.random()*Math.PI, rotV:(Math.random()-.5)*0.22, shape:Math.random()<.4?'star':'circle' });
  }
}
function tickParticles() {
  for (let i=particles.length-1;i>=0;i--) {
    const p=particles[i];
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.22; p.vx*=0.97;
    p.life-=0.021; p.r*=0.974; p.rot+=p.rotV;
    if (p.life<=0||p.r<.4) particles.splice(i,1);
  }
}
function drawParticles() {
  particles.forEach(p=>{
    ctx.save(); ctx.globalAlpha=Math.max(0,p.life); ctx.fillStyle=p.color;
    ctx.translate(p.x,p.y); ctx.rotate(p.rot);
    if (p.shape==='star') {
      ctx.beginPath();
      for (let i=0;i<10;i++){const r=i%2===0?p.r:p.r*.42,a=i*Math.PI/5-Math.PI/2;i===0?ctx.moveTo(r*Math.cos(a),r*Math.sin(a)):ctx.lineTo(r*Math.cos(a),r*Math.sin(a));}
      ctx.closePath(); ctx.fill();
    } else { ctx.beginPath(); ctx.arc(0,0,p.r,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
  });
  ctx.globalAlpha=1;
}

// ‚îÄ‚îÄ‚îÄ Rings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnRing(x,y,color='#FFD166') { ringPulses.push({x,y,r:0,maxR:BIRD_R*3.5,life:1,color}); }
function tickRings() { ringPulses.forEach(r=>{r.r+=4*S;r.life-=0.045;}); ringPulses=ringPulses.filter(r=>r.life>0); }
function drawRings() {
  ringPulses.forEach(r=>{
    ctx.save(); ctx.globalAlpha=r.life*0.7; ctx.strokeStyle=r.color; ctx.lineWidth=2.5*r.life;
    ctx.beginPath(); ctx.arc(r.x,r.y,r.r,0,Math.PI*2); ctx.stroke(); ctx.restore();
  });
}

// ‚îÄ‚îÄ‚îÄ Trail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnTrail(x,y) { trailDots.push({x,y,r:BIRD_R*0.55,life:1}); }
function tickTrail() { trailDots.forEach(t=>{t.life-=0.07;t.r*=0.92;}); trailDots=trailDots.filter(t=>t.life>0); }
function drawTrail() {
  // Trail colour per skin ‚Äî matches each bird's main body colour
  const TRAIL_COLORS=['#FDE047','#34d399','#6b7280','#818cf8','#1e293b','#ec4899'];
  const col = TRAIL_COLORS[activeSkin] || '#FDE047';
  trailDots.forEach(t=>{
    ctx.save(); ctx.globalAlpha=t.life*0.28; ctx.fillStyle=col;
    ctx.beginPath(); ctx.arc(t.x,t.y,t.r,0,Math.PI*2); ctx.fill(); ctx.restore();
  });
}

// ‚îÄ‚îÄ‚îÄ Popups ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addPopup(x,y,text,color='#FFD166') { popups.push({x,y,a:1,vy:-1.8,text,color}); }
function tickPopups() { popups.forEach(p=>{p.y+=p.vy;p.vy*=0.95;p.a-=0.022;}); popups=popups.filter(p=>p.a>0); }
function drawPopups() {
  ctx.textAlign='center';
  const fs=Math.round(W*0.056);
  ctx.font=`bold ${fs}px "Fredoka One",cursive`;
  popups.forEach(p=>{
    ctx.globalAlpha=p.a;
    ctx.fillStyle='rgba(0,0,0,.4)'; ctx.fillText(p.text,p.x+1.5,p.y+2);
    ctx.fillStyle=p.color; ctx.fillText(p.text,p.x,p.y);
  });
  ctx.globalAlpha=1;
}

// ‚îÄ‚îÄ‚îÄ Shake ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function triggerShake(intensity) { shakeAmt=intensity; }
function tickShake() {
  if (shakeAmt<0.3){shakeAmt=0;shakeX=0;shakeY=0;return;}
  shakeX=(Math.random()-.5)*shakeAmt; shakeY=(Math.random()-.5)*shakeAmt; shakeAmt*=0.72;
}

// ‚îÄ‚îÄ‚îÄ Haptic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vibe(pattern) { if (hapticOn&&navigator.vibrate) navigator.vibrate(pattern); }

// ‚îÄ‚îÄ‚îÄ Hearts UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateHearts() {
  heartRow.innerHTML='';
  for (let i=0;i<MAX_LIVES;i++) {
    const el=document.createElement('span'); el.textContent=i<lives?'‚ù§Ô∏è':'üñ§'; heartRow.appendChild(el);
  }
}

// ‚îÄ‚îÄ‚îÄ Power-Up System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastPowerUpSpawn = 0;
const POWERUP_INTERVAL = 12000; // ms between power-up spawns

function maybeSpawnPowerUp(ts) {
  if (!powerupsOn) return;
  if (score < 3) return;
  if (ts - lastPowerUpSpawn < POWERUP_INTERVAL) return;
  lastPowerUpSpawn = ts;

  const typeObj = POWERUP_TYPES[Math.floor(Math.random()*POWERUP_TYPES.length)];
  // Keep y safely inside the playfield
  const minY = GROUND_H + BIRD_R*2;
  const maxY = H - GROUND_H - BIRD_R*2;
  powerUpQueue.push({
    x: W + 30,
    y: minY + Math.random() * (maxY - minY),
    typeObj,               // full object stored here
    r: BIRD_R * 1.1,       // slightly bigger hitbox so it's catchable
    collected: false,
    alpha: 0
  });
}

function tickPowerUps(ts) {
  // Tick active power-up countdown
  if (activePowerUp) {
    activePowerUp.timer--;
    if (activePowerUp.timer <= 0) {
      SFX.powerDown();
      addPopup(bird.x, bird.y - BIRD_R*3, `${activePowerUp.emoji} ENDED`, '#94a3b8');
      activePowerUp = null;
      powerUpDisplay.style.opacity = '0';
    } else {
      const frac = activePowerUp.timer / activePowerUp.maxTimer;
      powerUpDisplay.textContent = activePowerUp.emoji + ' ' + Math.ceil(activePowerUp.timer/60) + 's';
      powerUpDisplay.style.opacity = '1';
      powerUpDisplay.style.color = frac < 0.3 ? '#f87171' : '#FFD166';
    }
  }

  // Move power-ups across screen
  const sp = activePowerUp?.id === 'slowmo' ? pipeSpeed * 0.22 : pipeSpeed;
  for (let i = powerUpQueue.length-1; i>=0; i--) {
    const pu = powerUpQueue[i];
    pu.x -= sp;
    pu.alpha = Math.min(1, pu.alpha + 0.05);
    if (pu.x + pu.r < 0) { powerUpQueue.splice(i,1); continue; }

    // Collection radius ‚Äî magnet makes it much easier to grab
    const collectR = pu.r + (activePowerUp?.id === 'magnet' ? BIRD_R*5 : BIRD_R);
    const dx = bird.x - pu.x, dy = bird.y - pu.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (!pu.collected && dist < collectR) {
      pu.collected = true;
      powerUpQueue.splice(i,1);
      collectPowerUp(pu.typeObj);
    }
  }
}

function collectPowerUp(typeObj) {
  // Store the id string separately so all comparisons work correctly
  activePowerUp = {
    id:       typeObj.id,
    emoji:    typeObj.emoji,
    label:    typeObj.label,
    color:    typeObj.color,
    timer:    typeObj.duration,
    maxTimer: typeObj.duration,
  };
  SFX.powerUp();
  triggerShake(4*S);
  vibe([20,10,20]);
  spawnParticles(bird.x, bird.y, 20, [typeObj.color,'#fff','#FFD166']);
  spawnRing(bird.x, bird.y, typeObj.color);
  addPopup(bird.x, bird.y - BIRD_R*2.5, `${typeObj.emoji} ${typeObj.label.toUpperCase()}!`, typeObj.color);

  if (typeObj.id === 'shield') {
    invincibleTimer = Math.max(invincibleTimer, typeObj.duration);
  }
}

function drawPowerUps() {
  powerUpQueue.forEach(pu => {
    ctx.save();
    ctx.globalAlpha = pu.alpha;
    // Pulsing glow
    const t = performance.now()/1000;
    const pulse = 0.7 + 0.3*Math.sin(t*3);
    const g = ctx.createRadialGradient(pu.x,pu.y,0,pu.x,pu.y,pu.r*2.5);
    g.addColorStop(0, pu.typeObj.color+'88');
    g.addColorStop(1,'transparent');
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.arc(pu.x,pu.y,pu.r*2.5,0,Math.PI*2); ctx.fill();

    // Pill background
    ctx.fillStyle = 'rgba(5,1,20,.82)';
    ctx.strokeStyle = pu.typeObj.color;
    ctx.lineWidth = 2*S;
    ctx.beginPath(); ctx.arc(pu.x,pu.y,pu.r*pulse,0,Math.PI*2);
    ctx.fill(); ctx.stroke();

    // Emoji
    ctx.font = `${Math.round(pu.r*1.2)}px serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(pu.typeObj.emoji, pu.x, pu.y);
    ctx.textBaseline='alphabetic';
    ctx.restore();
  });
}

// Effective bird radius considering tiny power-up
function effectiveBirdR() {
  return activePowerUp?.id === 'tiny' ? BIRD_R * 0.5 : BIRD_R;
}

// ‚îÄ‚îÄ‚îÄ Game init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initGame() {
  bird          = { x:W*.22, y:H*.44, vy:0 };
  pipes         = [];
  powerUpQueue  = [];
  activePowerUp = null;
  score         = 0;
  lives         = MAX_LIVES;
  comboCount    = 0;
  maxCombo      = 0;
  difficulty    = 0;
  pipeSpeed     = BASE_PIPE_SPEED;
  gapSize       = BASE_GAP;
  invincibleTimer = 0;
  deathFrames   = 0;
  nearMissCount = 0;
  lastPipePassTime = 0;
  lastPowerUpSpawn = performance.now() - POWERUP_INTERVAL * 0.5;
  sessionStart  = performance.now();
  particles     = [];
  popups        = [];
  ringPulses    = [];
  trailDots     = [];
  groundOffset  = 0;
  gamePaused    = false;
  gameRunning   = true;
  gameStarted   = true;
  lastTs        = 0;

  updateHearts();
  comboDisplay.style.opacity = '0';
  powerUpDisplay.style.opacity = '0';
  powerBar.style.opacity = '0';
  pauseOverlay.classList.remove('show');
  showScreen('playing');
  cancelAnimationFrame(animId);
  cancelAnimationFrame(idleAnimId);
  idleAnimId = null;
  if (musicOn) startAmbient();

  // Show 3-2-1 as a simple HTML overlay, game runs underneath
  showCountdownOverlay(() => {
    lastPipeTime = performance.now(); // start pipe timer fresh when GO fires
  });

  animId = requestAnimationFrame(gameLoop);
}

// ‚îÄ‚îÄ‚îÄ Countdown overlay (pure HTML/CSS ‚Äî no canvas, no rAF conflicts) ‚îÄ‚îÄ
function showCountdownOverlay(onDone) {
  const el = document.getElementById('countdownOverlay');
  const numEl = document.getElementById('countdownNum');
  let n = 3;

  function show(label, color) {
    numEl.textContent = label;
    numEl.style.color = color;
    numEl.style.textShadow = `0 0 40px ${color}`;
    // Restart animation by removing/re-adding class
    numEl.classList.remove('pop');
    void numEl.offsetWidth; // force reflow
    numEl.classList.add('pop');
  }

  el.style.display = 'flex';
  countdownActive = true;
  show(n, '#F4845F');
  SFX.flap();

  const iv = setInterval(() => {
    n--;
    if (n <= 0) {
      clearInterval(iv);
      show('GO!', '#86efac');
      SFX.score();
      setTimeout(() => {
        el.style.display = 'none';
        countdownActive = false;
        onDone();
      }, 600);
    } else {
      show(n, n === 2 ? '#FFD166' : '#86efac');
      SFX.flap();
    }
  }, 1000);
}

// ‚îÄ‚îÄ‚îÄ Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function flap() {
  if (!gameRunning || gamePaused) return;
  bird.vy = BASE_FLAP;
  flapBoost = true;
  SFX.flap();
  spawnParticles(bird.x-BIRD_R*.4, bird.y+BIRD_R*.3, 5, ['#FFD166','#FFE599','#fff','#F4A636']);
  vibe(14);
}

document.addEventListener('keydown', e => {
  if (e.code==='Space'||e.code==='ArrowUp') { e.preventDefault(); flap(); }
  if (e.code==='KeyP'||e.code==='Escape') {
    e.preventDefault();
    if (currentScreen==='playing') { gamePaused ? resumeGame() : pauseGame(); }
  }
});
canvas.addEventListener('pointerdown', e => {
  if (currentScreen==='playing' && !gamePaused) { e.preventDefault(); flap(); }
  else if (currentScreen==='playing' && gamePaused) { e.preventDefault(); resumeGame(); }
});

// ‚îÄ‚îÄ‚îÄ Pipes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnPipe(ts) {
  // Never spawn if a pipe was just spawned too recently (min gap = 1 screen width)
  const lastPipe = pipes[pipes.length - 1];
  if (lastPipe && lastPipe.x > W * 0.55) return;
  const minTop = GROUND_H + gapSize*0.55;
  const maxTop = H - GROUND_H - gapSize - GROUND_H*0.55;
  const tints = [null,'rgba(0,60,20,.18)','rgba(0,30,60,.15)','rgba(40,0,10,.12)',null];
  pipes.push({ x:W+PIPE_W+2, gapTop:Math.random()*(maxTop-minTop)+minTop, gap:gapSize, passed:false, alpha:0, warn:false, nearMissChecked:false, tint:tints[Math.floor(Math.random()*tints.length)] });
  lastPipeTime = ts;
}

function collidesPipe(p) {
  const bR = effectiveBirdR();
  const m = bR*0.28;
  const bL=bird.x-bR+m, bRR=bird.x+bR-m, bT=bird.y-bR+m, bB=bird.y+bR-m;
  // Shield: no collision
  if (activePowerUp?.id==='shield') return false;
  return (bRR>p.x && bL<p.x+PIPE_W) && (bT<p.gapTop || bB>p.gapTop+p.gap);
}

// Called every frame from update() ‚Äî finds the next upcoming pipe and steers toward its gap
function applyMagnet() {
  if (activePowerUp?.id !== 'magnet') return;
  // Find the next pipe the bird hasn't passed yet
  const next = pipes.find(p => p.x + PIPE_W > bird.x - BIRD_R*2);
  if (!next) return;
  const gapCY = next.gapTop + next.gap / 2;
  const diff  = gapCY - bird.y;
  // Smooth proportional pull ‚Äî stronger when far, gentle when close
  // Keeps flap responsive: only nudges velocity, never overrides it fully
  const pull  = diff * 0.055;
  bird.vy     = bird.vy * 0.88 + pull * 0.12;
  bird.vy     = Math.max(-9*S, Math.min(9*S, bird.vy));
}

function checkNearMiss(p) {
  if (p.nearMissChecked||p.passed) return;
  const bR=effectiveBirdR(), m=bR*0.28;
  const bT=bird.y-bR+m, bB=bird.y+bR-m;
  const threshold=bR*1.6;
  const nearTop    = bT>p.gapTop-threshold && bT<p.gapTop+threshold*0.5;
  const nearBottom = bB<p.gapTop+p.gap+threshold && bB>p.gapTop+p.gap-threshold*0.5;
  const hOverlap   = bird.x+bR>p.x && bird.x-bR<p.x+PIPE_W;
  if (hOverlap&&(nearTop||nearBottom)) {
    p.nearMissChecked=true; nearMissCount++;
    score+=2; SFX.nearMiss();
    addPopup(bird.x,bird.y-bR*2,'‚ö° NEAR MISS +2','#84f5d5');
    spawnParticles(bird.x,bird.y,8,['#84f5d5','#fff','#FFD166']);
  }
}

// ‚îÄ‚îÄ‚îÄ Difficulty ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateDifficulty() {
  difficulty = Math.min(score/30,1);
  const slowFactor = activePowerUp?.id==='slowmo' ? 0.22 : 1; // pipes almost stop
  pipeSpeed  = (BASE_PIPE_SPEED + difficulty*BASE_PIPE_SPEED*0.75) * slowFactor;
  gapSize    = BASE_GAP - difficulty*BASE_GAP*0.22;
}

// ‚îÄ‚îÄ‚îÄ Damage / death ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function takeDamage() {
  if (invincibleTimer>0||activePowerUp?.id==='shield') return;
  lives--; SFX.hit(); triggerShake(10*S); vibe([40,30,40]);
  updateHearts(); comboCount=0; comboDisplay.style.opacity='0';
  if (lives<=0) { triggerDeath(); }
  else { invincibleTimer=120; SFX.shield(); spawnParticles(bird.x,bird.y,18,['#ff6b6b','#ff8e8e','#fff','#ffd166']); }
}

function triggerDeath() {
  gameRunning=false;
  gamePaused=false;
  cancelAnimationFrame(animId);
  animId=null;
  stopAmbient();
  spawnParticles(bird.x,bird.y,60,['#FFD166','#F4845F','#F28482','#fff','#FFE599','#c3f584','#84f5d5'],1.2);
  SFX.die(); triggerShake(18*S); vibe([60,40,80]);
  const isNewBest=saveBest(score);
  const elapsed=Math.round((performance.now()-sessionStart)/1000);

  // Freeze the bird's final position for the drop animation
  const birdStartY = bird.y;
  let df = 0;
  let deathAnimId = null;

  function deathAnim(ts) {
    // Stop once stats screen shows (75 frames ‚âà 1.25s) or game restarted
    if (df >= 75 || gameRunning) { cancelAnimationFrame(deathAnimId); return; }
    tickShake(); drawBg(ts);
    ctx.save(); ctx.translate(shakeX,shakeY);
    pipes.forEach(p=>renderPipe(p));
    drawGround();
    renderBird(bird.x, birdStartY + df*1.8, 4);
    drawParticles(); tickParticles();
    ctx.restore();
    df++;
    deathAnimId = requestAnimationFrame(deathAnim);
  }
  deathAnimId = requestAnimationFrame(deathAnim);

  setTimeout(()=>{
    cancelAnimationFrame(deathAnimId);
    showStats(isNewBest,elapsed);
  }, 850);
}

function showStats(isNewBest, elapsed) {
  const medal=score>=50?'üèÜ':score>=25?'ü•á':score>=10?'ü•à':score>=4?'ü•â':'üíÄ';
  const msg  =score>=25?'Legendary run! üî•':score>=10?'Not bad at all!':'Keep grinding‚Ä¶';
  statsMedal.textContent=medal; statsTitle.textContent=score>=10?'Nice Run!':'Game Over';
  statsMsg.textContent=msg;
  st_score.textContent=score; st_best.textContent=bestScore;
  st_combo.textContent=maxCombo; st_time.textContent=elapsed+'s';
  st_pipes.textContent=score; st_near.textContent=nearMissCount;
  newBestBadge.style.display=isNewBest?'inline-block':'none';
  buildSkinStrip();
  showScreen('stats');
}

// ‚îÄ‚îÄ‚îÄ Update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function update(ts, dt=1) {
  if (countdownActive) return; // entire world frozen during countdown
  updateDifficulty();

  // Slow-mo only slows pipes ‚Äî gravity/flap unchanged so player keeps full control
  bird.vy += GRAVITY * dt;
  applyMagnet();
  bird.y  += bird.vy * dt;

  if (invincibleTimer>0) invincibleTimer--;

  if (bird.y-effectiveBirdR()<0) { bird.y=effectiveBirdR(); bird.vy=Math.abs(bird.vy)*0.3; }
  if (bird.y+effectiveBirdR()>=H-GROUND_H) {
    if (invincibleTimer>0||activePowerUp?.id==='shield') { bird.y=H-GROUND_H-effectiveBirdR(); bird.vy=BASE_FLAP*0.5; }
    else { takeDamage(); if(!gameRunning)return; bird.y=H-GROUND_H-effectiveBirdR()*1.2; bird.vy=BASE_FLAP*0.4; }
  }

  if (flapBoost){wingAngle=-0.7;flapBoost=false;}
  wingAngle+=wingDir*0.13;
  if (wingAngle>0.58){wingAngle=0.58;wingDir=-1;} if(wingAngle<-0.58){wingAngle=-0.58;wingDir=1;}

  groundOffset=(groundOffset+pipeSpeed*dt)%Math.round(60*S);
  BUSHES.forEach(b=>{b.x-=pipeSpeed*0.55*dt;if(b.x+b.r<0)b.x=W+b.r;});
  FAR_CLOUDS.forEach(c=>{c.x-=c.spd*S*dt;if(c.x+c.w<0)c.x=W+20;});
  MID_CLOUDS.forEach(c=>{c.x-=c.spd*S*dt;if(c.x+c.w<0)c.x=W+20;});
  NEAR_CLOUDS.forEach(c=>{c.x-=c.spd*S*dt;if(c.x+c.w<0)c.x=W+20;});

  const effectivePipeEvery = Math.max(1000, PIPE_EVERY - difficulty*400);
  if (ts-lastPipeTime>effectivePipeEvery) spawnPipe(ts);

  maybeSpawnPowerUp(ts);
  tickPowerUps(ts);

  for (let i=pipes.length-1;i>=0;i--) {
    const p=pipes[i];
    p.x -= pipeSpeed * dt;
    p.alpha=Math.min(1,p.alpha+0.07);
    p.warn=(p.x-bird.x)<W*0.28&&!p.passed;
    if (p.x+PIPE_W<0){pipes.splice(i,1);continue;}
    if (collidesPipe(p)){takeDamage();if(!gameRunning)return;}
    if (!p.passed&&!p.nearMissChecked&&bird.x+effectiveBirdR()>p.x&&bird.x-effectiveBirdR()<p.x+PIPE_W) checkNearMiss(p);
    if (!p.passed&&bird.x>p.x+PIPE_W) {
      p.passed=true; score++; SFX.score();
      spawnRing(p.x+PIPE_W/2,p.gapTop+p.gap/2);
      spawnParticles(bird.x,bird.y,6,['#FFD166','#fff','#86efac','#fbbf24'],0.6);
      triggerShake(1.5*S);
      const now=performance.now();
      if (lastPipePassTime&&(now-lastPipePassTime)<COMBO_WINDOW) comboCount++;
      else comboCount=1;
      lastPipePassTime=now;
      if (comboCount>maxCombo) maxCombo=comboCount;
      if (comboCount>=3) {
        score+=comboCount-2;
        addPopup(bird.x,bird.y-BIRD_R*2.5,`üî• x${comboCount} COMBO!`,'#FF8C00');
        SFX.combo();
        spawnParticles(bird.x,bird.y-BIRD_R,12,['#FFD166','#FF8C00','#fff']);
        comboDisplay.textContent=`üî• COMBO x${comboCount}`; comboDisplay.style.opacity='1';
        setTimeout(()=>{comboDisplay.style.opacity='0';},1200);
      } else {
        addPopup(p.x+PIPE_W/2,H/2-H*.08,'+1');
        if (comboCount===1) comboDisplay.style.opacity='0';
      }
    }
  }

  tickShake(); tickParticles(); tickPopups(); tickRings(); tickTrail();

  camT+=0.018;
  camX=Math.sin(camT*0.7)*1.2*S;
  camY=Math.sin(camT*1.1)*1.0*S+shakeX;

  if (gameRunning&&Math.round(performance.now()/16)%2===0) spawnTrail(bird.x,bird.y);

  FIREFLIES.forEach(f=>{f.x+=f.vx;f.y+=f.vy;f.phase+=f.spd;if(f.x<-10)f.x=W+10;if(f.x>W+10)f.x=-10;if(f.y<0)f.y=H*0.65;if(f.y>H*0.7)f.y=0;});
  LEAVES.forEach(l=>{l.x+=l.vx;l.y+=l.vy+Math.sin(l.wobble)*0.15;l.wobble+=l.wobbleSpd;l.rot+=l.rotV;if(l.x<-20)l.x=W+20;});
  DUST.forEach(d=>{d.x+=d.vx;d.y+=d.vy;d.phase+=0.02;if(d.x<-5)d.x=W+5;});
  FG_BRANCHES.forEach(b=>{b.x-=b.spd;if(b.x+b.w<0)b.x=W+b.w+Math.random()*W*0.5;});
}

// ‚îÄ‚îÄ‚îÄ Drawers (unchanged from v1.2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _skyCache = null, _skyD = -1, _skyH = -1;
function drawBg(ts) {
  const d=typeof difficulty==='number'?Math.round(difficulty*20)/20:0; // quantize to 0.05 steps
  if (_skyD !== d || _skyH !== H) {
    _skyD = d; _skyH = H;
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,`hsl(${258-d*20},85%,${5+d*2}%)`);
    g.addColorStop(0.28,`hsl(${245-d*25},75%,${14+d*4}%)`);
    g.addColorStop(0.58,`hsl(${320-d*40},55%,${30+d*8}%)`);
    g.addColorStop(0.78,`hsl(${15+d*5},75%,${48-d*10}%)`);
    g.addColorStop(0.90,`hsl(${30+d*5},90%,${55-d*12}%)`);
    g.addColorStop(1,'#0d0320');
    _skyCache = g;
  }
  const sky = _skyCache;
  ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);
  const sunX=W*.76,sunY=H*.76;
  const sun=ctx.createRadialGradient(sunX,sunY,0,sunX,sunY,H*.2);
  sun.addColorStop(0,`rgba(255,${200-d*60},${80-d*40},.9)`);
  sun.addColorStop(0.3,`rgba(255,${130-d*40},${40-d*20},.4)`);
  sun.addColorStop(1,'transparent');
  ctx.fillStyle=sun; ctx.fillRect(0,0,W,H);
  STARS.forEach(s=>{const t=.5+.5*Math.sin(ts*s.ts+s.to);ctx.globalAlpha=s.a*t;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();});
  ctx.globalAlpha=1;
  drawMtnRidge(MOUNTAINS_FAR,`rgba(14,6,35,.88)`);
  drawMtnRidge(MOUNTAINS_NEAR,`rgba(${18+d*10},6,${28+d*6},.95)`);
  FAR_CLOUDS.forEach(c=>drawCloud(c.x,c.y,c.w,c.h,0.12));
  MID_CLOUDS.forEach(c=>drawCloud(c.x,c.y,c.w,c.h,0.19));
  NEAR_CLOUDS.forEach(c=>drawCloud(c.x,c.y,c.w,c.h,0.28));
  drawGround();
}

function drawMtnRidge(pts,fill) {
  ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
  for (let i=1;i<pts.length-2;i++){const mx=(pts[i].x+pts[i+1].x)/2,my=(pts[i].y+pts[i+1].y)/2;ctx.quadraticCurveTo(pts[i].x,pts[i].y,mx,my);}
  ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath(); ctx.fillStyle=fill; ctx.fill();
}

function drawCloud(x,y,w,h,alpha) {
  ctx.save(); ctx.globalAlpha=alpha;
  const g=ctx.createRadialGradient(x+w*.5,y+h*.4,0,x+w*.5,y+h*.4,w*.6);
  g.addColorStop(0,'rgba(255,210,190,.7)'); g.addColorStop(1,'transparent');
  ctx.fillStyle=g; ctx.fillRect(x,y-h,w,h*3);
  ctx.fillStyle='rgba(255,255,255,.82)';
  [[.5,.55,.52,.4],[.22,.68,.3,.36],[.78,.70,.27,.32],[.35,.50,.22,.28],[.65,.52,.2,.26]]
    .forEach(([cx,cy,rx,ry])=>{ctx.beginPath();ctx.ellipse(x+w*cx,y+h*cy,w*rx,h*ry,0,0,Math.PI*2);ctx.fill();});
  ctx.restore();
}

function drawGround() {
  const dg=ctx.createLinearGradient(0,H-GROUND_H,0,H);
  dg.addColorStop(0,'#5c3a15'); dg.addColorStop(.3,'#3b2310'); dg.addColorStop(1,'#1e0f06');
  ctx.fillStyle=dg; ctx.fillRect(0,H-GROUND_H,W,GROUND_H);
  const gg=ctx.createLinearGradient(0,H-GROUND_H-4,0,H-GROUND_H+18);
  gg.addColorStop(0,'#4ade80'); gg.addColorStop(.5,'#22c55e'); gg.addColorStop(1,'#15803d');
  ctx.fillStyle=gg; ctx.fillRect(0,H-GROUND_H-4,W,22);
  ctx.fillStyle='#14532d'; ctx.fillRect(0,H-GROUND_H+16,W,3);
  const step=Math.round(60*S);
  ctx.strokeStyle='rgba(0,0,0,.12)'; ctx.lineWidth=1.5;
  for(let gx=-(step)+(groundOffset%step);gx<W+step;gx+=step){ctx.beginPath();ctx.moveTo(gx,H-GROUND_H+22);ctx.lineTo(gx+step*.66,H);ctx.stroke();}
  BUSHES.forEach(b=>{
    const bY=H-GROUND_H-b.r*.4; ctx.globalAlpha=0.85;
    const bg=ctx.createRadialGradient(b.x,bY-b.r*.3,0,b.x,bY,b.r*1.2);
    bg.addColorStop(0,'#4ade80'); bg.addColorStop(.5,'#16a34a'); bg.addColorStop(1,'#14532d');
    ctx.fillStyle=bg;
    [[0,0,1],[-.6,-.1,.72],[.6,.05,.68],[-.3,-.4,.5],[.35,-.35,.48]].forEach(([ox,oy,sr])=>{ctx.beginPath();ctx.arc(b.x+ox*b.r,bY+oy*b.r,b.r*sr,0,Math.PI*2);ctx.fill();});
    ctx.globalAlpha=1;
  });
}

function drawFireflies(ts) {
  FIREFLIES.forEach(f=>{
    const pulse=0.4+0.6*Math.sin(f.phase);
    ctx.save(); ctx.globalAlpha=pulse*0.75;
    const g=ctx.createRadialGradient(f.x,f.y,0,f.x,f.y,f.r*4);
    g.addColorStop(0,f.color); g.addColorStop(1,'transparent');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(f.x,f.y,f.r*4,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=pulse; ctx.fillStyle='#fff';
    ctx.beginPath(); ctx.arc(f.x,f.y,f.r*0.6,0,Math.PI*2); ctx.fill();
    ctx.restore();
  });
}

function drawLeaves() {
  LEAVES.forEach(l=>{
    ctx.save(); ctx.globalAlpha=l.alpha; ctx.translate(l.x,l.y); ctx.rotate(l.rot);
    ctx.fillStyle='#4ade80'; ctx.beginPath(); ctx.ellipse(0,0,l.size,l.size*0.45,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=0.7; ctx.beginPath(); ctx.moveTo(-l.size,0); ctx.lineTo(l.size,0); ctx.stroke();
    ctx.restore();
  });
}

function drawDust() {
  DUST.forEach(d=>{
    const a=d.alpha*(0.6+0.4*Math.sin(d.phase)); ctx.save(); ctx.globalAlpha=a;
    ctx.fillStyle='rgba(255,230,180,1)'; ctx.beginPath(); ctx.arc(d.x,d.y,d.r,0,Math.PI*2); ctx.fill(); ctx.restore();
  });
}

function drawForeground() {
  FG_BRANCHES.forEach(b=>{
    ctx.save(); ctx.globalAlpha=0.55; ctx.fillStyle='#0f0520';
    if (b.side==='top') {
      ctx.beginPath(); ctx.moveTo(b.x,0); ctx.quadraticCurveTo(b.x+b.w*0.4,b.y*0.6,b.x+b.w,b.y); ctx.lineTo(b.x+b.w,0); ctx.closePath(); ctx.fill();
      for (let i=0;i<4;i++){const tx=b.x+b.w*(0.2+i*0.2),ty=b.y*(0.5+i*0.12);ctx.strokeStyle='rgba(15,5,32,.6)';ctx.lineWidth=2.5-i*0.4;ctx.beginPath();ctx.moveTo(tx,ty);ctx.quadraticCurveTo(tx+8,ty+16+i*8,tx-4,ty+28+i*10);ctx.stroke();}
    } else {
      ctx.beginPath(); ctx.moveTo(b.x,H); ctx.quadraticCurveTo(b.x+b.w*0.4,H-b.y*0.5,b.x+b.w,H-b.y); ctx.lineTo(b.x+b.w,H); ctx.closePath(); ctx.fill();
    }
    ctx.restore();
  });
  const fog=ctx.createLinearGradient(0,0,W*0.18,0);
  fog.addColorStop(0,'rgba(10,3,30,.32)'); fog.addColorStop(1,'transparent');
  ctx.fillStyle=fog; ctx.fillRect(0,0,W*0.18,H);
  const fog2=ctx.createLinearGradient(W,0,W*0.82,0);
  fog2.addColorStop(0,'rgba(10,3,30,.28)'); fog2.addColorStop(1,'transparent');
  ctx.fillStyle=fog2; ctx.fillRect(W*0.82,0,W*0.18,H);
}

function renderPipe(p) {
  ctx.save(); ctx.globalAlpha=p.alpha;
  const capH=Math.round(24*S),capE=Math.round(14*S);
  drawPipeSection(p.x,0,PIPE_W,p.gapTop,true,capH,capE,p.warn);
  const bY=p.gapTop+p.gap, bH=H-bY;
  drawPipeSection(p.x,bY,PIPE_W,bH,false,capH,capE,p.warn);
  if (p.tint){ctx.fillStyle=p.tint;ctx.fillRect(p.x,0,PIPE_W,p.gapTop);ctx.fillRect(p.x,bY,PIPE_W,bH);}
  ctx.restore();
  ctx.save(); ctx.globalAlpha=p.alpha*(p.warn?.65:.4);
  const cx=p.x+PIPE_W/2,cy=p.gapTop+p.gap/2;
  const gg=ctx.createRadialGradient(cx,cy,0,cx,cy,p.gap*.55);
  gg.addColorStop(0,p.warn?'rgba(255,150,50,.2)':'rgba(255,220,80,.1)'); gg.addColorStop(1,'transparent');
  ctx.fillStyle=gg; ctx.fillRect(p.x-capE,p.gapTop,PIPE_W+capE*2,p.gap);
  ctx.restore();
}

function drawPipeSection(x,y,w,h,isTop,capH,capE,warn) {
  if (h<=0) return;
  const capX=x-capE/2,capW=w+capE,capY=isTop?y+h-capH:y;
  const bg=ctx.createLinearGradient(x,0,x+w,0);
  bg.addColorStop(0,'#166534'); bg.addColorStop(.12,'#4ade80'); bg.addColorStop(.38,'#16a34a'); bg.addColorStop(.7,'#15803d'); bg.addColorStop(1,'#052e16');
  ctx.fillStyle=bg; ctx.fillRect(x,y,w,h);
  const edgeH=Math.min(h,Math.round(20*S));
  const edgeShadow=ctx.createLinearGradient(0,isTop?y+h-edgeH:y,0,isTop?y+h:y+edgeH);
  edgeShadow.addColorStop(0,'transparent'); edgeShadow.addColorStop(1,'rgba(0,0,0,.38)');
  ctx.fillStyle=edgeShadow; ctx.fillRect(x,isTop?y+h-edgeH:y,w,edgeH);
  const cg=ctx.createLinearGradient(capX,0,capX+capW,0);
  cg.addColorStop(0,'#14532d'); cg.addColorStop(.1,'#4ade80'); cg.addColorStop(.4,'#22c55e'); cg.addColorStop(.85,'#15803d'); cg.addColorStop(1,'#052e16');
  ctx.fillStyle=cg; ctx.beginPath(); ctx.roundRect(capX,capY,capW,capH,6); ctx.fill();
  ctx.save(); ctx.shadowColor=warn?'#ffaa44':'#86efac'; ctx.shadowBlur=warn?20:13;
  ctx.strokeStyle=warn?'rgba(255,160,60,.65)':'rgba(134,239,172,.5)'; ctx.lineWidth=1.8;
  ctx.beginPath(); ctx.roundRect(capX,capY,capW,capH,6); ctx.stroke(); ctx.restore();
  const hs=ctx.createLinearGradient(x,0,x+w*.24,0);
  hs.addColorStop(0,'rgba(255,255,255,.22)'); hs.addColorStop(1,'transparent');
  ctx.fillStyle=hs; ctx.fillRect(x,y,w*.24,h);
}

function renderBird(x,y,vy) {
  const BASE = activePowerUp?.id==='tiny' ? BIRD_R*0.5 : BIRD_R;
  const R    = BASE;
  const tilt = Math.min(Math.max(vy*0.055,-0.62),1.55);
  const isInv= invincibleTimer>0;
  const T    = performance.now()/1000;

  ctx.save(); ctx.translate(x,y); ctx.rotate(tilt);
  if (isInv && Math.floor(invincibleTimer/4)%2===0){ ctx.restore(); return; }

  // ‚îÄ‚îÄ Power-up overlays ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (activePowerUp?.id==='shield') {
    ctx.save();
    ctx.globalAlpha = 0.5 + 0.3*Math.sin(T*5);
    ctx.strokeStyle = `rgba(134,239,172,${activePowerUp.timer/activePowerUp.maxTimer})`;
    ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,R*1.7,0,Math.PI*2); ctx.stroke();
    ctx.restore();
  }
  if (activePowerUp?.id==='slowmo') {
    ctx.save(); ctx.globalAlpha=0.15; ctx.fillStyle='#c4b5fd';
    ctx.beginPath(); ctx.arc(0,0,R*1.7,0,Math.PI*2); ctx.fill(); ctx.restore();
  }

  // ‚îÄ‚îÄ Halo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const hR = isInv ? R*3.8 : R*2.6;
  const halo = ctx.createRadialGradient(0,0,R*.4,0,0,hR);
  halo.addColorStop(0, isInv?'rgba(100,200,255,.4)':'rgba(255,220,60,.18)');
  halo.addColorStop(1,'transparent');
  ctx.fillStyle=halo; ctx.beginPath(); ctx.arc(0,0,hR,0,Math.PI*2); ctx.fill();

  // ‚îÄ‚îÄ Drop shadow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ctx.save(); ctx.scale(1,.28);
  ctx.beginPath(); ctx.ellipse(0,R*3.6,R*.9,R*.45,0,0,Math.PI*2);
  ctx.fillStyle='rgba(0,0,0,.15)'; ctx.fill(); ctx.restore();

  // ‚îÄ‚îÄ Dispatch to per-skin draw functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  switch(activeSkin) {
    case 0: drawClassic(R,T); break;
    case 1: drawParrot(R,T);  break;
    case 2: drawEagle(R,T);   break;
    case 3: drawOwl(R,T);     break;
    case 4: drawPenguin(R,T); break;
    case 5:
      // Flamingo: body is the hitbox center. Shift render so the body sits at origin,
      // neck+head extend upward visually but don't affect collision.
      ctx.save(); ctx.translate(0, R*0.55); drawFlamingo(R,T); ctx.restore();
      break;
    default: drawClassic(R,T);
  }

  ctx.restore();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 0 ¬∑ CLASSIC ‚Äî round yellow canary, simple & clean
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawClassic(R,T) {
  // Wing (flapping ellipse behind body)
  ctx.save(); ctx.rotate(wingAngle*0.8);
  const wg=ctx.createLinearGradient(-R*.6,0,R*.1,R);
  wg.addColorStop(0,'#FCD34D'); wg.addColorStop(1,'#92400E');
  ctx.fillStyle=wg;
  ctx.beginPath(); ctx.ellipse(-R*.38,R*.3,R*.5,R*.85,-0.3,0,Math.PI*2); ctx.fill();
  ctx.restore();

  // Tail ‚Äî three fan feathers
  [[-0.18,1.3],[-0.38,1.2],[-0.58,1.05]].forEach(([a,l],i)=>{
    ctx.save(); ctx.rotate(a);
    ctx.strokeStyle=['#EAB308','#CA8A04','#A16207'][i];
    ctx.lineWidth=3.5-i*0.8; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(-R*.55,R*.1); ctx.quadraticCurveTo(-R*l,R*.5,-R*l,R*.0);
    ctx.stroke(); ctx.restore();
  });

  // Body ‚Äî plump circle
  const bg=ctx.createRadialGradient(-R*.3,-R*.3,R*.05,R*.1,R*.1,R*1.1);
  bg.addColorStop(0,'#FEF9C3'); bg.addColorStop(0.4,'#FDE047'); bg.addColorStop(1,'#92400E');
  ctx.fillStyle=bg; ctx.beginPath(); ctx.arc(0,0,R,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=1.2; ctx.stroke();

  // Belly highlight
  const belly=ctx.createRadialGradient(R*.1,R*.28,0,R*.1,R*.28,R*.48);
  belly.addColorStop(0,'rgba(255,255,245,.7)'); belly.addColorStop(1,'transparent');
  ctx.fillStyle=belly; ctx.beginPath(); ctx.ellipse(R*.1,R*.28,R*.42,R*.38,0,0,Math.PI*2); ctx.fill();

  // Eye
  ctx.beginPath(); ctx.arc(R*.38,-R*.18,R*.34,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
  ctx.beginPath(); ctx.arc(R*.41,-R*.2,R*.19,0,Math.PI*2); ctx.fillStyle='#451A03'; ctx.fill();
  ctx.beginPath(); ctx.arc(R*.44,-R*.23,R*.09,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill();
  ctx.beginPath(); ctx.arc(R*.32,-R*.28,R*.08,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.9)'; ctx.fill();

  // Blush
  const bl=ctx.createRadialGradient(R*.55,R*.08,0,R*.55,R*.08,R*.22);
  bl.addColorStop(0,'rgba(255,100,80,.35)'); bl.addColorStop(1,'transparent');
  ctx.fillStyle=bl; ctx.beginPath(); ctx.arc(R*.55,R*.08,R*.22,0,Math.PI*2); ctx.fill();

  // Beak
  ctx.beginPath(); ctx.moveTo(R*.78,-R*.06);
  ctx.quadraticCurveTo(R*1.52,-R*.04,R*1.46,R*.08);
  ctx.quadraticCurveTo(R*1.16,R*.12,R*.78,R*.06); ctx.closePath();
  ctx.fillStyle='#FB923C'; ctx.fill();
  ctx.beginPath(); ctx.moveTo(R*.80,R*.08);
  ctx.quadraticCurveTo(R*1.38,R*.14,R*1.33,R*.24);
  ctx.quadraticCurveTo(R*1.06,R*.28,R*.80,R*.22); ctx.closePath();
  ctx.fillStyle='#EA580C'; ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=.8;
  ctx.beginPath(); ctx.moveTo(R*.80,R*.07); ctx.lineTo(R*1.44,R*.07); ctx.stroke();

  // Sheen
  const sh=ctx.createRadialGradient(-R*.4,-R*.4,0,-R*.2,-R*.2,R*.65);
  sh.addColorStop(0,'rgba(255,255,255,.3)'); sh.addColorStop(1,'transparent');
  ctx.fillStyle=sh; ctx.beginPath(); ctx.arc(0,0,R,0,Math.PI*2); ctx.fill();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 1 ¬∑ PARROT ‚Äî wide body, dramatic crest, hooked beak, colourful
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawParrot(R,T) {
  // Long sweeping tail feathers
  [['#3b82f6',0.05,1.7],['#a855f7',-0.18,1.55],['#ef4444',-0.38,1.45],['#f59e0b',-0.55,1.3]].forEach(([col,a,l])=>{
    ctx.save(); ctx.translate(-R*.5,R*.1); ctx.rotate(a);
    ctx.strokeStyle=col; ctx.lineWidth=3.5; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(-R*l*0.5,R*l*0.5,-R*l,R*l*0.08);
    ctx.stroke(); ctx.restore();
  });

  // Wing ‚Äî broad, showing blue-green gradient
  ctx.save(); ctx.rotate(wingAngle*0.9);
  const wg=ctx.createLinearGradient(-R*.7,0,R*.2,R*.8);
  wg.addColorStop(0,'#34d399'); wg.addColorStop(0.5,'#059669'); wg.addColorStop(1,'#022c22');
  ctx.fillStyle=wg;
  ctx.beginPath(); ctx.ellipse(-R*.42,R*.28,R*.62,R*.98,-0.25,0,Math.PI*2); ctx.fill();
  // Wing stripe
  ctx.strokeStyle='rgba(52,211,153,.6)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(-R*.85,R*.6); ctx.quadraticCurveTo(-R*.5,R*.2,-R*.1,R*.5); ctx.stroke();
  ctx.restore();

  // Crest ‚Äî three curved feathers pointing up-back
  [['#f97316',0,1.6],['#ef4444',-0.22,1.45],['#fde047',0.18,1.38]].forEach(([col,a,len])=>{
    ctx.save(); ctx.translate(-R*.05,-R*.82); ctx.rotate(a);
    ctx.strokeStyle=col; ctx.lineWidth=3; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(-R*.2,-R*len*0.55,-R*.05,-R*len);
    ctx.stroke();
    // Crest tip dot
    ctx.fillStyle=col; ctx.beginPath(); ctx.arc(-R*.05,-R*len,R*.08,0,Math.PI*2); ctx.fill();
    ctx.restore();
  });

  // Body ‚Äî wide oval, vivid green
  const bg=ctx.createRadialGradient(-R*.32,-R*.28,R*.04,R*.08,R*.08,R*1.18);
  bg.addColorStop(0,'#bbf7d0'); bg.addColorStop(0.35,'#34d399'); bg.addColorStop(0.7,'#059669'); bg.addColorStop(1,'#022c22');
  ctx.fillStyle=bg;
  ctx.beginPath(); ctx.ellipse(0,0,R*1.06,R,0,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=1.2; ctx.stroke();

  // Cheek patches ‚Äî yellow circles
  ctx.fillStyle='#fef08a';
  ctx.beginPath(); ctx.ellipse(R*.38,-R*.05,R*.22,R*.18,0,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.1)'; ctx.lineWidth=.8; ctx.stroke();

  // Eye ‚Äî big yellow-ringed
  ctx.beginPath(); ctx.arc(R*.35,-R*.22,R*.30,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
  // Yellow eye-ring
  ctx.strokeStyle='#fbbf24'; ctx.lineWidth=2.2;
  ctx.beginPath(); ctx.arc(R*.35,-R*.22,R*.32,0,Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.arc(R*.37,-R*.24,R*.18,0,Math.PI*2); ctx.fillStyle='#1d4ed8'; ctx.fill();
  ctx.beginPath(); ctx.arc(R*.39,-R*.26,R*.09,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill();
  ctx.beginPath(); ctx.arc(R*.28,-R*.30,R*.07,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.9)'; ctx.fill();

  // Hooked beak ‚Äî upper mandible curves down at tip
  ctx.beginPath();
  ctx.moveTo(R*.72,-R*.08);
  ctx.bezierCurveTo(R*1.4,-R*.1,R*1.55,R*.04,R*1.42,R*.22);
  ctx.bezierCurveTo(R*1.3,R*.35,R*1.1,R*.22,R*.72,R*.06);
  ctx.closePath();
  ctx.fillStyle='#fde047'; ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=.9; ctx.stroke();
  // Lower
  ctx.beginPath(); ctx.moveTo(R*.74,R*.08);
  ctx.quadraticCurveTo(R*1.18,R*.18,R*1.1,R*.30);
  ctx.quadraticCurveTo(R*.92,R*.36,R*.74,R*.24); ctx.closePath();
  ctx.fillStyle='#ca8a04'; ctx.fill();

  // Sheen
  const sh=ctx.createRadialGradient(-R*.38,-R*.38,0,-R*.2,-R*.2,R*.72);
  sh.addColorStop(0,'rgba(255,255,255,.28)'); sh.addColorStop(1,'transparent');
  ctx.fillStyle=sh; ctx.beginPath(); ctx.ellipse(0,0,R*1.06,R,0,0,Math.PI*2); ctx.fill();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 2 ¬∑ EAGLE ‚Äî tall narrow body, white head, fierce brow, spread wings
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawEagle(R,T) {
  // Spread wing (large, flat, angular)
  ctx.save(); ctx.rotate(wingAngle*0.6);
  ctx.beginPath();
  ctx.moveTo(-R*.2,R*.1);
  ctx.bezierCurveTo(-R*.6,-R*.1,-R*1.3,-R*.05,-R*1.45,R*.28);
  ctx.bezierCurveTo(-R*1.3,R*.55,-R*.8,R*.7,-R*.2,R*.45);
  ctx.closePath();
  const wg=ctx.createLinearGradient(-R*1.4,0,0,R*.5);
  wg.addColorStop(0,'#1f2937'); wg.addColorStop(0.5,'#374151'); wg.addColorStop(1,'#4b5563');
  ctx.fillStyle=wg; ctx.fill();
  // Primary feather tips ‚Äî white tipped
  for(let i=0;i<5;i++){
    const fx=-R*(1.0+i*0.07), fy=R*(0.22+i*0.04);
    ctx.fillStyle='rgba(255,255,255,.25)';
    ctx.beginPath(); ctx.ellipse(fx,fy,R*.07,R*.2,0.2+i*0.08,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();

  // Tail ‚Äî wedge shaped
  ctx.beginPath();
  ctx.moveTo(-R*.5,R*.1);
  ctx.bezierCurveTo(-R*1.1,R*.2,-R*1.4,R*.5,-R*1.3,R*.7);
  ctx.bezierCurveTo(-R*1.0,R*.85,-R*.6,R*.6,-R*.5,R*.35);
  ctx.closePath();
  ctx.fillStyle='#374151'; ctx.fill();
  // Tail feather lines
  for(let i=0;i<4;i++){
    ctx.strokeStyle='rgba(100,116,139,.6)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(-R*.55,R*.22+i*R*.04); ctx.lineTo(-R*1.25,R*.55+i*R*.05); ctx.stroke();
  }

  // Body ‚Äî taller narrow teardrop
  const bg=ctx.createRadialGradient(-R*.2,-R*.4,R*.04,0,0,R*1.05);
  bg.addColorStop(0,'#6b7280'); bg.addColorStop(0.5,'#4b5563'); bg.addColorStop(1,'#1f2937');
  ctx.fillStyle=bg;
  ctx.beginPath(); ctx.ellipse(0,0,R*.88,R*1.08,0,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.3)'; ctx.lineWidth=1.2; ctx.stroke();

  // White head cap ‚Äî covers top 55% of body
  ctx.beginPath();
  ctx.ellipse(R*.02,-R*.28,R*.72,R*.7,0,0,Math.PI*2);
  ctx.fillStyle='#f1f5f9'; ctx.fill();

  // Chest streaks ‚Äî dark brown vertical streaks
  ctx.strokeStyle='rgba(55,65,81,.5)'; ctx.lineWidth=1.5; ctx.lineCap='round';
  [[-R*.12,R*.1],[-R*.02,R*.08],[R*.1,R*.12],[-R*.2,R*.18]].forEach(([sx,sy])=>{
    ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(sx+R*.04,sy+R*.28); ctx.stroke();
  });

  // Fierce eye with heavy brow
  ctx.beginPath(); ctx.arc(R*.32,-R*.28,R*.30,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
  ctx.beginPath(); ctx.arc(R*.34,-R*.28,R*.18,0,Math.PI*2); ctx.fillStyle='#92400e'; ctx.fill();
  ctx.beginPath(); ctx.arc(R*.36,-R*.30,R*.09,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill();
  ctx.beginPath(); ctx.arc(R*.26,-R*.34,R*.07,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.9)'; ctx.fill();
  // Heavy brow ridge ‚Äî drawn as dark filled arc
  ctx.fillStyle='#374151';
  ctx.beginPath();
  ctx.moveTo(R*.05,-R*.44);
  ctx.bezierCurveTo(R*.15,-R*.58,R*.48,-R*.52,R*.58,-R*.40);
  ctx.bezierCurveTo(R*.56,-R*.35,R*.48,-R*.42,R*.14,-R*.40);
  ctx.closePath(); ctx.fill();

  // Yellow hooked beak
  ctx.beginPath();
  ctx.moveTo(R*.68,-R*.18);
  ctx.bezierCurveTo(R*1.42,-R*.22,R*1.58,-R*.04,R*1.42,R*.16);
  ctx.bezierCurveTo(R*1.28,R*.32,R*1.08,R*.16,R*.68,R*.02);
  ctx.closePath();
  const bkG=ctx.createLinearGradient(R*.68,-R*.18,R*1.42,R*.16);
  bkG.addColorStop(0,'#fef08a'); bkG.addColorStop(1,'#b45309');
  ctx.fillStyle=bkG; ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=.9; ctx.stroke();
  // Cere (fleshy bit at beak base)
  ctx.fillStyle='#fcd34d';
  ctx.beginPath(); ctx.ellipse(R*.82,-R*.18,R*.12,R*.08,-.3,0,Math.PI*2); ctx.fill();

  // Sheen
  const sh=ctx.createRadialGradient(-R*.35,-R*.42,0,-R*.18,-R*.22,R*.68);
  sh.addColorStop(0,'rgba(255,255,255,.22)'); sh.addColorStop(1,'transparent');
  ctx.fillStyle=sh; ctx.beginPath(); ctx.ellipse(0,0,R*.88,R*1.08,0,0,Math.PI*2); ctx.fill();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 3 ¬∑ OWL ‚Äî large round head, flat facial disc, ear tufts, huge eyes
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawOwl(R,T) {
  // Stubby rounded tail
  ctx.beginPath();
  ctx.moveTo(-R*.55,R*.2);
  ctx.quadraticCurveTo(-R*1.1,R*.55,-R*.95,R*.8);
  ctx.quadraticCurveTo(-R*.65,R*.95,-R*.45,R*.55);
  ctx.closePath(); ctx.fillStyle='#4338ca'; ctx.fill();
  // Tail bars
  ctx.strokeStyle='rgba(99,102,241,.5)'; ctx.lineWidth=1.5;
  for(let i=0;i<3;i++){
    ctx.beginPath(); ctx.moveTo(-R*(.55+i*.12),R*(.3+i*.08)); ctx.lineTo(-R*(.9+i*.04),R*(.65+i*.08)); ctx.stroke();
  }

  // Wing ‚Äî rounded, tucked close
  ctx.save(); ctx.rotate(wingAngle*0.7);
  const wg=ctx.createLinearGradient(-R*.5,0,R*.1,R*.7);
  wg.addColorStop(0,'#818cf8'); wg.addColorStop(0.5,'#4338ca'); wg.addColorStop(1,'#1e1b4b');
  ctx.fillStyle=wg;
  ctx.beginPath(); ctx.ellipse(-R*.35,R*.32,R*.52,R*.88,-0.18,0,Math.PI*2); ctx.fill();
  // Feather texture lines on wing
  ctx.strokeStyle='rgba(129,140,248,.4)'; ctx.lineWidth=1.2;
  for(let i=0;i<3;i++){
    ctx.beginPath(); ctx.moveTo(-R*(.6+i*.08),R*(.5-i*.1)); ctx.quadraticCurveTo(-R*(.3+i*.08),R*(.3-i*.08),-R*(.05+i*.04),R*(.55-i*.08)); ctx.stroke();
  }
  ctx.restore();

  // BODY ‚Äî very round, chunky
  const bg=ctx.createRadialGradient(-R*.25,-R*.25,R*.04,R*.08,R*.12,R*1.15);
  bg.addColorStop(0,'#fef3c7'); bg.addColorStop(0.25,'#c7d2fe'); bg.addColorStop(0.6,'#6366f1'); bg.addColorStop(1,'#1e1b4b');
  ctx.fillStyle=bg;
  ctx.beginPath(); ctx.arc(0,0,R*1.08,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.22)'; ctx.lineWidth=1.3; ctx.stroke();

  // Breast/belly ‚Äî cream horizontal barring
  ctx.fillStyle='rgba(254,243,199,.75)';
  ctx.beginPath(); ctx.ellipse(R*.04,R*.22,R*.52,R*.58,0,0,Math.PI*2); ctx.fill();
  // Barring lines across belly
  ctx.strokeStyle='rgba(99,102,241,.25)'; ctx.lineWidth=1.5;
  for(let i=0;i<5;i++){
    ctx.beginPath(); ctx.moveTo(-R*.4,R*(-0.04+i*.16)); ctx.quadraticCurveTo(R*.04,R*(-0.06+i*.16),R*.42,R*(-0.04+i*.16)); ctx.stroke();
  }

  // EAR TUFTS ‚Äî before the face
  [[-R*.32,-R*.94],[R*.06,-R*.98]].forEach(([ex,ey],si)=>{
    ctx.fillStyle='#312e81';
    ctx.beginPath();
    ctx.moveTo(ex-R*.1,ey+R*.2);
    ctx.bezierCurveTo(ex-R*.18,ey-R*.05,ex-R*.05,ey-R*.45,ex,ey-R*.52);
    ctx.bezierCurveTo(ex+R*.05,ey-R*.45,ex+R*.18,ey-R*.05,ex+R*.1,ey+R*.2);
    ctx.closePath(); ctx.fill();
    // Lighter inner tuft
    ctx.fillStyle='#4338ca';
    ctx.beginPath();
    ctx.moveTo(ex-R*.04,ey+R*.15);
    ctx.bezierCurveTo(ex-R*.06,ey-R*.02,ex-R*.01,ey-R*.35,ex+R*.02,ey-R*.4);
    ctx.bezierCurveTo(ex+R*.05,ey-R*.35,ex+R*.06,ey-R*.02,ex+R*.04,ey+R*.15);
    ctx.closePath(); ctx.fill();
  });

  // FACIAL DISC ‚Äî the flat circular face of an owl
  const disc=ctx.createRadialGradient(0,-R*.18,0,0,-R*.18,R*.78);
  disc.addColorStop(0,'rgba(254,243,199,.9)'); disc.addColorStop(0.7,'rgba(199,210,254,.5)'); disc.addColorStop(1,'transparent');
  ctx.fillStyle=disc;
  ctx.beginPath(); ctx.ellipse(0,-R*.18,R*.72,R*.68,0,0,Math.PI*2); ctx.fill();
  // Disc border rings
  ctx.strokeStyle='rgba(67,56,202,.3)'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.ellipse(0,-R*.18,R*.73,R*.69,0,0,Math.PI*2); ctx.stroke();
  ctx.strokeStyle='rgba(67,56,202,.15)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.ellipse(0,-R*.18,R*.65,R*.61,0,0,Math.PI*2); ctx.stroke();

  // TWO HUGE EYES ‚Äî the owl's signature feature
  [[-R*.28,-R*.24],[R*.28,-R*.24]].forEach(([oex,oey])=>{
    // Outer dark ring
    ctx.beginPath(); ctx.arc(oex,oey,R*.30,0,Math.PI*2);
    ctx.fillStyle='#1e1b4b'; ctx.fill();
    // White sclera
    ctx.beginPath(); ctx.arc(oex,oey,R*.26,0,Math.PI*2); ctx.fillStyle='#fffbeb'; ctx.fill();
    // Golden iris with radial pattern
    const iris=ctx.createRadialGradient(oex,oey,0,oex,oey,R*.20);
    iris.addColorStop(0,'#fef08a'); iris.addColorStop(0.4,'#f59e0b'); iris.addColorStop(0.8,'#d97706'); iris.addColorStop(1,'#92400e');
    ctx.fillStyle=iris; ctx.beginPath(); ctx.arc(oex,oey,R*.20,0,Math.PI*2); ctx.fill();
    // Pupil ‚Äî vertical slit like a real owl
    ctx.fillStyle='#000';
    ctx.beginPath(); ctx.ellipse(oex,oey,R*.07,R*.14,0,0,Math.PI*2); ctx.fill();
    // Two catch lights
    ctx.fillStyle='rgba(255,255,255,.92)';
    ctx.beginPath(); ctx.arc(oex-R*.06,oey-R*.08,R*.055,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(oex+R*.08,oey+R*.04,R*.03,0,Math.PI*2); ctx.fill();
  });

  // Small hooked beak centered between eyes
  ctx.beginPath();
  ctx.moveTo(-R*.08,R*.02);
  ctx.bezierCurveTo(-R*.06,-R*.08,R*.06,-R*.08,R*.08,R*.02);
  ctx.bezierCurveTo(R*.1,R*.14,R*.02,R*.22,-R*.02,R*.22);
  ctx.bezierCurveTo(-R*.06,R*.22,-R*.1,R*.14,-R*.08,R*.02);
  ctx.closePath();
  ctx.fillStyle='#fbbf24'; ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=.8; ctx.stroke();

  // Sheen
  const sh=ctx.createRadialGradient(-R*.42,-R*.48,0,-R*.22,-R*.28,R*.72);
  sh.addColorStop(0,'rgba(255,255,255,.28)'); sh.addColorStop(1,'transparent');
  ctx.fillStyle=sh; ctx.beginPath(); ctx.arc(0,0,R*1.08,0,Math.PI*2); ctx.fill();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 4 ¬∑ PENGUIN ‚Äî upright egg shape, tuxedo, flipper wings, bow tie
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawPenguin(R,T) {
  // Flipper ‚Äî flat, black, swept back
  ctx.save(); ctx.rotate(-wingAngle*0.5+0.3);
  ctx.beginPath();
  ctx.moveTo(-R*.15,R*.02);
  ctx.bezierCurveTo(-R*.5,-R*.28,-R*1.22,-R*.18,-R*1.28,R*.18);
  ctx.bezierCurveTo(-R*1.22,R*.48,-R*.5,R*.55,-R*.15,R*.42);
  ctx.closePath();
  ctx.fillStyle='#0f172a'; ctx.fill();
  ctx.strokeStyle='rgba(100,116,139,.3)'; ctx.lineWidth=.8; ctx.stroke();
  ctx.restore();

  // Tail ‚Äî short stubby wedge
  ctx.beginPath();
  ctx.moveTo(-R*.38,R*.55);
  ctx.quadraticCurveTo(-R*.7,R*.9,-R*.55,R*1.05);
  ctx.quadraticCurveTo(-R*.3,R*1.1,-R*.2,R*.72);
  ctx.closePath(); ctx.fillStyle='#0f172a'; ctx.fill();

  // BODY ‚Äî tall egg, wider at bottom (tuxedo back)
  const bgBack=ctx.createRadialGradient(-R*.2,-R*.1,R*.05,0,0,R*1.08);
  bgBack.addColorStop(0,'#1e293b'); bgBack.addColorStop(0.5,'#0f172a'); bgBack.addColorStop(1,'#020617');
  ctx.fillStyle=bgBack;
  ctx.beginPath(); ctx.ellipse(0,0,R*.96,R*1.06,0,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.3)'; ctx.lineWidth=1.2; ctx.stroke();

  // TUXEDO BELLY ‚Äî white front patch
  const belly=ctx.createRadialGradient(R*.06,R*.18,0,R*.06,R*.18,R*.7);
  belly.addColorStop(0,'#f8fafc'); belly.addColorStop(0.6,'#e2e8f0'); belly.addColorStop(1,'transparent');
  ctx.fillStyle=belly;
  ctx.beginPath(); ctx.ellipse(R*.06,R*.18,R*.55,R*.72,0,0,Math.PI*2); ctx.fill();

  // WHITE FACE patch
  ctx.beginPath(); ctx.ellipse(R*.04,-R*.32,R*.56,R*.48,0,0,Math.PI*2);
  ctx.fillStyle='#f1f5f9'; ctx.fill();

  // BOW TIE
  const bx=R*.06, by=R*.52;
  ctx.fillStyle='#dc2626';
  // Left wing
  ctx.beginPath(); ctx.moveTo(bx,by);
  ctx.bezierCurveTo(bx-R*.3,by-R*.1,bx-R*.35,by+R*.08,bx,by+R*.04);
  ctx.fill();
  // Right wing
  ctx.beginPath(); ctx.moveTo(bx,by);
  ctx.bezierCurveTo(bx+R*.3,by-R*.1,bx+R*.35,by+R*.08,bx,by+R*.04);
  ctx.fill();
  // Knot
  ctx.fillStyle='#991b1b';
  ctx.beginPath(); ctx.arc(bx,by+R*.02,R*.055,0,Math.PI*2); ctx.fill();

  // SLEEPY EYES ‚Äî half-closed
  [R*.22,R*.42].forEach((oex)=>{
    const oey=-R*.36;
    ctx.beginPath(); ctx.arc(oex,oey,R*.22,0,Math.PI*2); ctx.fillStyle='#f1f5f9'; ctx.fill();
    ctx.beginPath(); ctx.arc(oex+R*.02,oey,R*.12,0,Math.PI*2); ctx.fillStyle='#0f172a'; ctx.fill();
    ctx.beginPath(); ctx.arc(oex+R*.04,oey,R*.06,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill();
    // Heavy drooping eyelid
    ctx.save();
    ctx.beginPath(); ctx.arc(oex,oey,R*.24,-Math.PI,0); ctx.fillStyle='#1e293b'; ctx.fill();
    ctx.restore();
    ctx.beginPath(); ctx.arc(oex-R*.06,oey-R*.08,R*.05,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.8)'; ctx.fill();
  });

  // Orange beak ‚Äî wide flat triangle
  ctx.beginPath();
  ctx.moveTo(-R*.12,R*.0);
  ctx.lineTo(R*.55,R*.0);
  ctx.lineTo(R*.45,R*.18);
  ctx.lineTo(-R*.08,R*.15);
  ctx.closePath();
  ctx.fillStyle='#fb923c'; ctx.fill();
  ctx.beginPath();
  ctx.moveTo(-R*.10,R*.15);
  ctx.lineTo(R*.44,R*.18);
  ctx.lineTo(R*.36,R*.30);
  ctx.lineTo(-R*.06,R*.26);
  ctx.closePath();
  ctx.fillStyle='#f97316'; ctx.fill();

  // Sheen
  const sh=ctx.createRadialGradient(-R*.38,-R*.44,0,-R*.18,-R*.24,R*.7);
  sh.addColorStop(0,'rgba(255,255,255,.22)'); sh.addColorStop(1,'transparent');
  ctx.fillStyle=sh; ctx.beginPath(); ctx.ellipse(0,0,R*.96,R*1.06,0,0,Math.PI*2); ctx.fill();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 5 ¬∑ FLAMINGO ‚Äî very slim body, long S-curve neck, long pink legs visible
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawFlamingo(R,T) {
  // Slim elongated tail
  [['#e879f9',-0.08,1.5],['#c026d3',-0.28,1.38],['#a21caf',-0.45,1.22]].forEach(([col,a,l])=>{
    ctx.save(); ctx.translate(-R*.48,R*.1); ctx.rotate(a);
    ctx.strokeStyle=col; ctx.lineWidth=3; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(-R*l*.4,R*l*.42,-R*l,R*l*.05);
    ctx.stroke(); ctx.restore();
  });

  // Wing ‚Äî slim, swept back, elegant
  ctx.save(); ctx.rotate(wingAngle*0.55);
  ctx.beginPath();
  ctx.moveTo(-R*.12,R*.06);
  ctx.bezierCurveTo(-R*.42,-R*.1,-R*1.08,-R*.04,-R*1.18,R*.26);
  ctx.bezierCurveTo(-R*1.08,R*.52,-R*.42,R*.6,-R*.12,R*.38);
  ctx.closePath();
  const wg=ctx.createLinearGradient(-R*1.2,0,0,R*.5);
  wg.addColorStop(0,'#be185d'); wg.addColorStop(0.4,'#ec4899'); wg.addColorStop(1,'#f9a8d4');
  ctx.fillStyle=wg; ctx.fill();
  // Darker primary feathers at wing tip
  ctx.fillStyle='rgba(157,23,77,.6)';
  for(let i=0;i<4;i++){
    ctx.beginPath(); ctx.ellipse(-R*(1.0+i*.06),R*(.2+i*.03),R*.06,R*.18,-.15+i*.05,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();

  // BODY ‚Äî very slim teardrop, tilted slightly
  const bg=ctx.createRadialGradient(-R*.18,-R*.22,R*.04,R*.06,R*.08,R*1.05);
  bg.addColorStop(0,'#fce7f3'); bg.addColorStop(0.3,'#f9a8d4'); bg.addColorStop(0.65,'#ec4899'); bg.addColorStop(1,'#831843');
  ctx.fillStyle=bg;
  ctx.beginPath(); ctx.ellipse(0,0,R*.78,R*1.04,0.12,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.18)'; ctx.lineWidth=1.2; ctx.stroke();

  // Belly ‚Äî lighter centre
  const belly=ctx.createRadialGradient(R*.06,R*.22,0,R*.06,R*.22,R*.44);
  belly.addColorStop(0,'rgba(252,231,243,.72)'); belly.addColorStop(1,'transparent');
  ctx.fillStyle=belly; ctx.beginPath(); ctx.ellipse(R*.06,R*.22,R*.36,R*.44,0,0,Math.PI*2); ctx.fill();

  // LONG S-CURVE NECK ‚Äî drawn as a thick curved path
  ctx.strokeStyle='#f9a8d4'; ctx.lineWidth=R*.34; ctx.lineCap='round';
  ctx.beginPath();
  ctx.moveTo(R*.12,-R*.72);
  ctx.bezierCurveTo(R*.32,-R*1.18,R*.55,-R*1.32,R*.35,-R*1.62);
  ctx.stroke();
  // Neck shading
  ctx.strokeStyle='rgba(190,24,93,.3)'; ctx.lineWidth=R*.12;
  ctx.beginPath();
  ctx.moveTo(R*.2,-R*.8);
  ctx.bezierCurveTo(R*.36,-R*1.14,R*.52,-R*1.28,R*.36,-R*1.56);
  ctx.stroke();

  // HEAD ‚Äî small oval at end of neck
  ctx.beginPath(); ctx.ellipse(R*.32,-R*1.72,R*.38,R*.32,0.35,0,Math.PI*2);
  const headG=ctx.createRadialGradient(R*.22,-R*1.8,0,R*.32,-R*1.72,R*.38);
  headG.addColorStop(0,'#fce7f3'); headG.addColorStop(0.5,'#f9a8d4'); headG.addColorStop(1,'#ec4899');
  ctx.fillStyle=headG; ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.15)'; ctx.lineWidth=.9; ctx.stroke();

  // Small dainty eye with eyelash
  const hx=R*.46, hy=-R*1.78;
  ctx.beginPath(); ctx.arc(hx,hy,R*.14,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
  ctx.beginPath(); ctx.arc(hx+R*.01,hy,R*.08,0,Math.PI*2); ctx.fillStyle='#be185d'; ctx.fill();
  ctx.beginPath(); ctx.arc(hx+R*.02,hy,R*.04,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill();
  ctx.beginPath(); ctx.arc(hx-R*.04,hy-R*.06,R*.04,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.9)'; ctx.fill();
  // Eyelash
  ctx.strokeStyle='#831843'; ctx.lineWidth=1.3; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(hx-R*.12,hy-R*.10); ctx.quadraticCurveTo(hx,hy-R*.22,hx+R*.12,hy-R*.12); ctx.stroke();

  // BENT FLAMINGO BEAK ‚Äî the iconic kinked bill
  ctx.beginPath();
  ctx.moveTo(R*.56,-R*1.75);
  ctx.bezierCurveTo(R*.92,-R*1.76,R*1.08,-R*1.68,R*1.04,-R*1.58);
  ctx.bezierCurveTo(R*1.0,-R*1.46,R*.82,-R*1.5,R*.52,-R*1.64);
  ctx.closePath();
  const bkG=ctx.createLinearGradient(R*.56,-R*1.75,R*1.08,-R*1.56);
  bkG.addColorStop(0,'#fde68a'); bkG.addColorStop(0.55,'#fb923c'); bkG.addColorStop(1,'#1e1b4b');
  ctx.fillStyle=bkG; ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=.8; ctx.stroke();
  // The kink bump
  ctx.fillStyle='rgba(30,27,75,.4)';
  ctx.beginPath(); ctx.ellipse(R*.88,-R*1.62,R*.08,R*.06,-.4,0,Math.PI*2); ctx.fill();

  // Sheen
  const sh=ctx.createRadialGradient(-R*.35,-R*.4,0,-R*.16,-R*.2,R*.68);
  sh.addColorStop(0,'rgba(255,255,255,.26)'); sh.addColorStop(1,'transparent');
  ctx.fillStyle=sh; ctx.beginPath(); ctx.ellipse(0,0,R*.78,R*1.04,0.12,0,Math.PI*2); ctx.fill();
}

function drawHUD() {
  const fs=Math.round(W*.1);
  ctx.textAlign='center';
  ctx.font=`bold ${fs}px "Fredoka One",cursive`;
  ctx.fillStyle='rgba(0,0,0,.45)'; ctx.fillText(score,W/2+2,fs+8);
  ctx.fillStyle='#fff'; ctx.fillText(score,W/2,fs+6);
  ctx.font=`${Math.round(W*.03)}px "Nunito",sans-serif`;
  ctx.fillStyle='rgba(255,255,255,.4)'; ctx.fillText('SCORE',W/2,fs+20);
}

// ‚îÄ‚îÄ‚îÄ Idle loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let idleAnimId = null;
function idleLoop() {
  cancelAnimationFrame(idleAnimId);
  birdIdleT=0;
  function frame(ts) {
    if (gameRunning){idleAnimId=null;return;}
    birdIdleT+=0.04;
    FIREFLIES.forEach(f=>{f.x+=f.vx;f.y+=f.vy;f.phase+=f.spd;if(f.x<-10)f.x=W+10;if(f.x>W+10)f.x=-10;});
    LEAVES.forEach(l=>{l.x+=l.vx;l.wobble+=l.wobbleSpd;l.rot+=l.rotV;if(l.x<-20)l.x=W+20;});
    DUST.forEach(d=>{d.x+=d.vx;d.phase+=0.02;if(d.x<-5)d.x=W+5;});
    drawBg(ts);
    drawDust(); drawFireflies(ts); drawLeaves();
    drawForeground();
    renderBird(W*.22,H*.44+Math.sin(birdIdleT)*6,-1);
    idleAnimId=requestAnimationFrame(frame);
  }
  idleAnimId=requestAnimationFrame(frame);
}

// ‚îÄ‚îÄ‚îÄ Main game loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function draw(ts) {
  ctx.save();
  ctx.translate(shakeX+camX, shakeY+camY);
  drawBg(ts);
  drawDust(); drawFireflies(ts); drawLeaves();
  pipes.forEach(p=>renderPipe(p));
  drawPowerUps();
  drawRings();
  drawGround();
  drawTrail();
  renderBird(bird.x,bird.y,bird.vy);
  drawParticles(); drawPopups();
  drawForeground();
  ctx.restore();
  drawHUD();
}

let lastTs = 0;
function gameLoop(ts) {
  if (!gameRunning || gamePaused) return;
  // Delta-time: clamp to avoid huge jumps after tab switch or countdown gap
  const rawDt = lastTs ? (ts - lastTs) / 16.667 : 1;
  const dt    = Math.min(Math.max(rawDt, 0.5), 1.5);
  lastTs = ts;
  update(ts, dt);
  if (gameRunning) { draw(ts); animId = requestAnimationFrame(gameLoop); }
}

// ‚îÄ‚îÄ‚îÄ PWA: Service Worker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      console.log('[PWA] SW registered:', reg.scope);
      // Listen for updates
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            // New content available ‚Äî could show a toast here
            console.log('[PWA] New version available');
          }
        });
      });
    }).catch(err => console.warn('[PWA] SW registration failed:', err));
  });
}

// ‚îÄ‚îÄ‚îÄ PWA: Network status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateOnlineStatus() {
  offlineBadge.style.display = navigator.onLine ? 'none' : 'block';
}
window.addEventListener('online',  updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();

// ‚îÄ‚îÄ‚îÄ PWA: Install prompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let deferredInstallPrompt = null;
const installBanner  = document.getElementById('installBanner');
const ibInstall      = document.getElementById('ib-install');
const ibDismiss      = document.getElementById('ib-dismiss');

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  // Show banner after 3s (non-intrusive)
  setTimeout(() => {
    if (!localStorage.getItem('fb_install_dismissed')) {
      installBanner.classList.add('show');
    }
  }, 3000);
});

ibInstall.addEventListener('click', async () => {
  installBanner.classList.remove('show');
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  const result = await deferredInstallPrompt.userChoice;
  console.log('[PWA] Install result:', result.outcome);
  deferredInstallPrompt = null;
});

ibDismiss.addEventListener('click', () => {
  installBanner.classList.remove('show');
  localStorage.setItem('fb_install_dismissed', '1');
});

window.addEventListener('appinstalled', () => {
  console.log('[PWA] App installed!');
  installBanner.classList.remove('show');
});

// ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
showScreen('menu');
idleLoop();
</script>
</body>
</html>